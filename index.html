<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÇ‡∏ï‡πä‡∏∞ - ‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤ ‡πÄ‡∏ü‡∏™‡∏ï‡∏¥‡∏ß‡∏±‡∏•</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;700&display=swap');

        body { font-family: 'Kanit', sans-serif; background-color: #050505; color: #fff; padding-bottom: 20px; position: relative; min-height: 100vh; }
        .container { max-width: 450px; margin-top: 15px; padding-bottom: 20px; }
        .hidden { display: none !important; }
        
        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á */
        .ticket-card {
            background: linear-gradient(135deg, #6200ea 0%, #b388ff 100%);
            border-radius: 25px;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(98, 0, 234, 0.5);
            border: 4px solid #fff;
            position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 0 auto; max-width: 350px;
        }
        .event-title { font-size: 28px; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin-bottom: 5px; line-height: 1.1; }
        .event-sub { font-size: 24px; color: #ffeb3b; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); margin-bottom: 20px; }
        .ticket-header { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.6); padding: 5px 25px; border-radius: 50px; font-size: 16px; margin-bottom: 25px; backdrop-filter: blur(5px); }
        
        /* QR Code */
        .qr-bg { background: #fff; padding: 15px; border-radius: 15px; margin: 0 auto 20px auto; width: 210px; height: 210px; display: flex; align-items: center; justify-content: center; }
        #qrcodeDisplay img, #modalQrcodeDisplay img { display: block; margin: 0 auto; }
        
        .cust-name { font-size: 26px; font-weight: 700; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .table-badge { font-size: 48px; font-weight: 700; background: #ffeb3b; color: #000; padding: 0px 40px; border-radius: 15px; box-shadow: 0 5px 10px rgba(0,0,0,0.3); margin-top: 5px; display: inline-block; }
        .footer-note { margin-top: 20px; font-size: 14px; opacity: 0.9; font-weight: 300; }

        /* --- ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Input (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠) --- */
        .form-control, .form-select { 
            background-color: #ffffff !important; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß */
            border: 2px solid #ddd;
            color: #0056b3 !important; /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
            font-weight: 600; 
            border-radius: 12px; 
            height: 50px; 
            font-size: 1.1rem; 
            text-align: center; 
        }
        .form-control:focus, .form-select:focus { 
            background-color: #f0f8ff !important; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÜ */
            border-color: #0056b3; 
            color: #0056b3 !important; 
            box-shadow: 0 0 10px rgba(0, 86, 179, 0.3); 
        }
        .form-control::placeholder {
            color: #aaa; /* Placeholder ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ */
            font-weight: 400;
        }
        
        .btn-main { background: linear-gradient(90deg, #00c6ff, #0072ff); border: none; height: 55px; font-size: 1.2rem; font-weight: 700; color: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 114, 255, 0.4); }
        .nav-pills .nav-link { background: #222; color: #aaa; border-radius: 10px; margin: 0 2px; }
        .nav-pills .nav-link.active { background: #6200ea; color: #fff; font-weight: bold; }
        
        .status-card { 
            background: #222; border-radius: 12px; border: 1px solid #333; transition: all 0.2s; cursor: pointer; 
        }
        .status-card:active { transform: scale(0.95); border-color: #fff; }
        
        .status-booked { border-bottom: 4px solid #ffc107; }
        .status-partial { border-bottom: 4px solid #fd7e14; }
        .status-full { border-bottom: 4px solid #2ecc71; opacity: 0.7; }
        
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .admin-table-container { overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .table-custom { background-color: #ffffff; color: #000000; font-size: 0.9rem; width: 100%; white-space: nowrap; margin-bottom: 0; }
        .table-custom th { background-color: #212529; color: #ffeb3b; padding: 15px; font-weight: 600; }
        .table-custom td { vertical-align: middle; color: #000000; padding: 12px 15px; border-bottom: 1px solid #dee2e6; }

        .btn-check:checked + .btn-vip { background-color: #ffc107; color: #000; border-color: #ffc107; box-shadow: 0 0 15px rgba(255, 193, 7, 0.5); }
        .btn-vip { border: 2px solid #ffc107; color: #ffc107; background: transparent; transition: all 0.2s; }
        .btn-check:checked + .btn-vvip { background-color: #d63384; color: #fff; border-color: #d63384; box-shadow: 0 0 15px rgba(214, 51, 132, 0.5); }
        .btn-vvip { border: 2px solid #d63384; color: #d63384; background: transparent; transition: all 0.2s; }
    </style>
</head>
<body>

<div class="container">
    <div class="user-container text-center mb-4">
        <h4 class="fw-bold mb-0">‚ú® ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ <span style="color:#ffeb3b">‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤‡∏Ø</span></h4>
        <h5 class="fw-bold mt-1" style="color: #ffeb3b; text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);">‡πÇ‡∏û-‡∏≠‡∏≠‡∏Å ‡πÄ‡∏ü‡∏™‡∏ï‡∏¥‡∏ß‡∏±‡∏•</h5>

        <ul class="nav nav-pills nav-fill mt-4">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#create">üìù ‡∏à‡∏≠‡∏á</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#status" onclick="loadTableStatus()">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#scan">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin" onclick="checkAdminAccess()">‚öôÔ∏è Admin</button></li>
        </ul>
    </div>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="create">
            <div class="user-container">
                <div class="card p-4 border-0 shadow mb-4" style="background: #151515; border-radius: 20px;">
                    
                    <div class="mb-4">
                        <label class="text-white-50 small mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡πÇ‡∏ï‡πä‡∏∞</label>
                        <div class="d-flex gap-2">
                            <input type="radio" class="btn-check" name="zoneOption" id="optVIP" value="VIP" checked>
                            <label class="btn btn-vip w-50 py-3 fw-bold rounded-3" for="optVIP">üé´ VIP (‡∏ä‡∏∏‡∏î 1)</label>

                            <input type="radio" class="btn-check" name="zoneOption" id="optVVIP" value="VVIP">
                            <label class="btn btn-vvip w-50 py-3 fw-bold rounded-3" for="optVVIP">üëë VVIP (‡∏ä‡∏∏‡∏î 2)</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <input type="text" id="custName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                    </div>
                    <div class="mb-3">
                        <input type="tel" id="custPhone" class="form-control" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
                    </div>
                    <div class="mb-3">
                        <input type="text" id="paymentRef" class="form-control" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                    </div>

                    <div class="mb-3">
                        <label class="text-white-50 small mb-1">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                        <select id="paymentMethod" class="form-select" onchange="toggleSlipInput()">
                            <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                            <option value="‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">üè¶ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                        </select>
                    </div>

                    <div id="slipUploadContainer" class="mb-4 hidden">
                        <label class="text-warning small mb-1">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                        <input type="file" id="slipFile" class="form-control" accept="image/*">
                    </div>
                    
                    <button onclick="addBooking()" id="btnSave" class="btn btn-main w-100">‚úÖ ‡∏£‡∏±‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                </div>
                
                <div id="ticketResult" class="hidden animate__animated animate__fadeInUp">
                    <p class="text-center text-success mb-2">üéâ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>
                    <div class="ticket-card" id="finalTicket">
                        <div class="event-title">‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤ ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤</div>
                        <div class="event-sub">‡πÇ‡∏û-‡∏≠‡∏≠‡∏Å ‡πÄ‡∏ü‡∏™‡∏ï‡∏¥‡∏ß‡∏±‡∏•</div>
                        <div class="ticket-header">‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ VIP</div>
                        <div class="qr-bg"><div id="qrcodeDisplay"></div></div>
                        <div class="cust-name" id="displayName">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                        <div class="table-badge" id="displayTable">...</div>
                        <div class="footer-note">*‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</div>
                    </div>
                    <div class="text-center mt-3 text-muted small">‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üì∏</div>
                    <button onclick="resetForm()" class="btn btn-outline-secondary w-100 mt-3 rounded-pill">‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="status">
            <div class="user-container">
                <button onclick="loadTableStatus()" class="btn btn-sm btn-secondary mb-3 w-100">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <div class="alert alert-info small text-center p-1 mb-2">‚ÑπÔ∏è ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á</div>
                <div id="statusList" class="row g-2"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="scan">
            <div class="user-container">
                <div class="card p-3 border-0 bg-dark text-center" style="border-radius: 20px;">
                    <div id="reader" style="border-radius: 15px; overflow: hidden;"></div>
                    <div id="scanResult" class="mt-3 text-white fw-bold">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô...</div>
                    <button onclick="startScanner()" class="btn btn-primary mt-3 w-100 py-3 rounded-pill">üì∏ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                    <button onclick="stopScanner()" class="btn btn-secondary mt-2 w-100 hidden" id="stopCamBtn">‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="admin">
            <div class="user-container" id="adminLoginContainer">
                <div id="adminLoginForm" class="card p-4 bg-dark border-0">
                    <input type="email" id="adminEmail" class="form-control mb-3" placeholder="Email">
                    <input type="password" id="adminPass" class="form-control mb-3" placeholder="Password">
                    <button onclick="login()" class="btn btn-light w-100 py-3 rounded-pill fw-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
            <div id="adminContent" class="hidden">
                <div class="d-flex justify-content-between mb-3 text-white align-items-center">
                    <span class="h4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin)</span>
                    <button onclick="logout()" class="btn btn-sm btn-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
                <button onclick="loadBookingsAdmin()" class="btn btn-info w-100 mb-3"><i class="bi bi-arrow-clockwise"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
                <div class="admin-table-container">
                    <table class="table table-custom">
                        <thead><tr><th>‡πÇ‡∏ï‡πä‡∏∞</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>üìÖ ‡∏à‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th><th>‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                        <tbody id="adminList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="ticketModal" class="custom-modal-overlay hidden">
    <div style="position: relative;">
        <button onclick="closeTicketModal()" style="position: absolute; top: -15px; right: -15px; z-index: 1000; background: red; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-weight: bold; box-shadow: 0 0 10px rgba(0,0,0,0.5);">X</button>
        
        <div class="ticket-card" id="modalTicketCard">
            <div class="event-title">‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤ ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤</div>
            <div class="event-sub">‡πÇ‡∏û-‡∏≠‡∏≠‡∏Å ‡πÄ‡∏ü‡∏™‡∏ï‡∏¥‡∏ß‡∏±‡∏•</div>
            <div class="ticket-header">‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ VIP</div>
            <div class="qr-bg"><div id="modalQrcodeDisplay"></div></div>
            <div class="cust-name" id="modalDisplayName">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            <div class="table-badge" id="modalDisplayTable">...</div>
            <div class="footer-note">*‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</div>
        </div>
        <div class="text-center mt-3 text-white">‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ üì∏</div>
    </div>
</div>

<div id="scanModal" class="custom-modal-overlay hidden">
    <div style="background:#fff;color:#000;width:90%;max-width:400px;padding:25px;border-radius:20px;text-align:center;border:5px solid #ffeb3b;">
        <div style="font-size:2rem;font-weight:800;margin-bottom:10px;">üì• ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</div>
        <div id="modalInfo" style="font-size:1.3rem;font-weight:500;margin-bottom:15px;"></div>
        <label class="d-block text-start fw-bold mt-2" style="font-size:1.2rem;">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Ñ‡∏ô):</label>
        <input type="number" id="modalPaxInput" style="width:100%;height:70px;font-size:3rem;text-align:center;font-weight:bold;border:3px solid #000;border-radius:15px;margin:10px 0 20px 0;background:#f8f9fa;color:#000;" value="1" min="1">
        <button onclick="confirmScan()" class="btn w-100 py-3 fs-4 fw-bold btn-success mb-2">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        <button onclick="closeScanModal()" class="btn w-100 py-3 fs-4 fw-bold btn-danger">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<div class="modal fade" id="slipModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-dark">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="slipImagePreview" src="" class="img-fluid rounded shadow">
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="qrModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-body text-center p-4">
         <div id="qrModalBody" class="bg-white p-3 d-inline-block rounded"></div>
      </div>
      <div class="modal-footer border-secondary p-1">
        <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD3s78zRwEHU5WAiSQIg78ZxWbS5QjXYws",
      authDomain: "my-booking-table-855b0.firebaseapp.com",
      projectId: "my-booking-table-855b0",
      storageBucket: "my-booking-table-855b0.firebasestorage.app",
      messagingSenderId: "589914860402",
      appId: "1:589914860402:web:d1033ebdd14b7f982c0beb",
      measurementId: "G-DFMJ4G668D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    
    let html5QrcodeScanner = null;
    let qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
    let slipModal = new bootstrap.Modal(document.getElementById('slipModal'));
    let currentScanDoc = null;
    let currentScanData = null;

    function formatThaiDate(timestamp) {
        if(!timestamp) return "-";
        return timestamp.toDate().toLocaleString('th-TH', { 
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
        });
    }

    async function getNextQueue(prefix) {
        const q = query(collection(db, "bookings"));
        const snapshot = await getDocs(q);
        let existingNumbers = [];
        snapshot.forEach(doc => {
            const t = doc.data().table; 
            if (t.startsWith(prefix)) {
                const numPart = parseInt(t.replace(prefix, ''));
                if (!isNaN(numPart)) existingNumbers.push(numPart);
            }
        });
        existingNumbers.sort((a, b) => a - b);
        let nextNum = 1;
        for (let num of existingNumbers) {
            if (num === nextNum) nextNum++; else if (num > nextNum) break; 
        }
        return prefix + String(nextNum).padStart(3, '0');
    }

    window.toggleSlipInput = () => {
        const method = document.getElementById('paymentMethod').value;
        const slipDiv = document.getElementById('slipUploadContainer');
        if(method === '‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ') slipDiv.classList.remove('hidden');
        else slipDiv.classList.add('hidden');
    }

    window.addBooking = async () => {
        const btn = document.getElementById('btnSave');
        const zonePrefix = document.querySelector('input[name="zoneOption"]:checked').value;
        const name = document.getElementById('custName').value;
        const phone = document.getElementById('custPhone').value;
        const payMethod = document.getElementById('paymentMethod').value; 
        const payRef = document.getElementById('paymentRef').value; 
        const slipFile = document.getElementById('slipFile').files[0];

        if(!name) return alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤");
        if(payMethod === '‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ' && !slipFile) {
            if(!confirm("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏∞‡∏à‡∏≠‡∏á‡πÑ‡∏´‡∏°?")) return;
        }

        btn.disabled = true; btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";

        try {
            const autoTableNo = await getNextQueue(zonePrefix);
            let slipUrl = "";
            if (slipFile) {
                btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ...";
                const storageRef = ref(storage, 'slips/' + Date.now() + '_' + slipFile.name);
                await uploadBytes(storageRef, slipFile);
                slipUrl = await getDownloadURL(storageRef);
            }

            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            
            const docRef = await addDoc(collection(db, "bookings"), {
                name, phone, table: autoTableNo, 
                paymentMethod: payMethod, paymentRef: payRef, slipUrl: slipUrl,
                status: "booked", pax: 0, maxPax: 4, 
                createdAt: serverTimestamp()
            });

            document.getElementById('ticketResult').classList.remove('hidden');
            const qrContainer = document.getElementById("qrcodeDisplay");
            qrContainer.innerHTML = ""; 
            new QRCode(qrContainer, { text: docRef.id, width: 180, height: 180, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
            document.getElementById('displayName').innerText = name;
            document.getElementById('displayTable').innerText = autoTableNo;
            btn.disabled = false; btn.innerText = "‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏Å‡∏î‡∏à‡∏≠‡∏á‡∏ï‡πà‡∏≠)";
            setTimeout(() => { document.getElementById('ticketResult').scrollIntoView({behavior: "smooth"}); }, 300);
        } catch (e) { 
            console.error(e); 
            alert("Error: " + e.message + "\n(‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Storage ‡πÉ‡∏ô Firebase Console ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?)"); 
            btn.disabled = false; btn.innerText = "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"; 
        }
    };

    window.resetForm = () => {
        document.getElementById('custName').value = '';
        document.getElementById('custPhone').value = '';
        document.getElementById('paymentRef').value = '';
        document.getElementById('slipFile').value = '';
        document.getElementById('ticketResult').classList.add('hidden');
        document.getElementById('qrcodeDisplay').innerHTML = "";
    };

    window.loadTableStatus = async () => {
        const display = document.getElementById('statusList');
        display.innerHTML = "<div class='text-center text-white'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>";
        const q = query(collection(db, "bookings"), orderBy("table", "asc"));
        const snapshot = await getDocs(q);
        display.innerHTML = "";
        
        if(snapshot.empty) { display.innerHTML = "<div class='text-center text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</div>"; return; }
        
        snapshot.forEach((doc) => {
            const d = doc.data();
            const currentPax = d.pax || 0;
            const maxPax = d.maxPax || 4;
            let statusClass = 'status-booked';
            let statusText = `üü° ‡∏£‡∏≠ (${currentPax}/${maxPax})`;
            let zoneColor = d.table.startsWith('VVIP') ? '#d63384' : '#ffc107';

            if (currentPax >= maxPax) {
                statusClass = 'status-full';
                statusText = `üü¢ ‡∏Ñ‡∏£‡∏ö (${maxPax}/${maxPax})`;
            } else if (currentPax > 0) {
                statusClass = 'status-partial';
                statusText = `üü† ‡πÄ‡∏Ç‡πâ‡∏≤ ${currentPax}/${maxPax}`;
            }
            
            display.innerHTML += `
                <div class="col-4 col-sm-4" onclick="openTicketModal('${doc.id}', '${d.name}', '${d.table}')">
                    <div class="status-card p-2 text-center ${statusClass}">
                        <h4 class="fw-bold mb-0" style="color:${zoneColor}">${d.table}</h4>
                        <small class="d-block text-truncate text-secondary" style="font-size:0.8rem;">${d.name}</small>
                        <span class="badge bg-dark mt-1" style="font-size:0.7rem;">${statusText}</span>
                    </div>
                </div>`;
        });
    };

    window.openTicketModal = (docId, name, table) => {
        document.getElementById('modalDisplayName').innerText = name;
        document.getElementById('modalDisplayTable').innerText = table;
        const qrContainer = document.getElementById("modalQrcodeDisplay");
        qrContainer.innerHTML = ""; 
        new QRCode(qrContainer, { text: docId, width: 180, height: 180, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
        document.getElementById('ticketModal').classList.remove('hidden');
    };

    window.closeTicketModal = () => {
        document.getElementById('ticketModal').classList.add('hidden');
    };

    window.startScanner = () => {
        document.getElementById('stopCamBtn').classList.remove('hidden');
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess, () => {});
    };
    window.stopScanner = () => {
        if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => {
            document.getElementById('reader').innerHTML = "";
            document.getElementById('stopCamBtn').classList.add('hidden');
        });
    };
    
    const onScanSuccess = async (decodedText) => {
        html5QrcodeScanner.pause();
        const resDiv = document.getElementById('scanResult');
        resDiv.innerHTML = "‚è≥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        
        try {
            const docRef = doc(db, "bookings", decodedText);
            const snap = await getDoc(docRef);
            
            if (snap.exists()) {
                currentScanDoc = docRef;
                currentScanData = snap.data();
                const d = currentScanData;
                const currentPax = d.pax || 0;
                const maxPax = d.maxPax || 4;
                const remaining = maxPax - currentPax;

                if (remaining <= 0) {
                    alert(`‚ùå ‡πÇ‡∏ï‡πä‡∏∞ ${d.table} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö ${maxPax} ‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!`);
                    resDiv.innerHTML = "<h3 class='text-danger'>‚ùå ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß</h3>";
                    setTimeout(() => html5QrcodeScanner.resume(), 2000);
                } else {
                    document.getElementById('modalInfo').innerHTML = `
                        ‡πÇ‡∏ï‡πä‡∏∞: <span style="color:#ffeb3b;font-size:1.5rem;font-weight:bold;">${d.table}</span><br>
                        ‡∏ä‡∏∑‡πà‡∏≠: ${d.name}<br>
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ${currentPax}/${maxPax}<br>
                        <span style="color:#d63384">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤: ${remaining} ‡∏Ñ‡∏ô</span>
                    `;
                    document.getElementById('modalPaxInput').value = 1;
                    document.getElementById('modalPaxInput').max = remaining;
                    document.getElementById('scanModal').classList.remove('hidden');
                }
            } else { 
                resDiv.innerHTML = `<h3 class='text-warning fw-bold'>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>`; 
                setTimeout(() => html5QrcodeScanner.resume(), 2000);
            }
        } catch (e) { 
            console.error(e);
            resDiv.innerHTML = "Error: " + e.message;
            setTimeout(() => html5QrcodeScanner.resume(), 2000);
        }
    };

    window.confirmModal = async () => {
        const amount = parseInt(document.getElementById('modalPaxInput').value);
        const currentPax = currentScanData.pax || 0;
        const maxPax = currentScanData.maxPax || 4;
        const remaining = maxPax - currentPax;

        if (amount > 0 && amount <= remaining) {
            const newPax = currentPax + amount;
            await updateDoc(currentScanDoc, { 
                pax: newPax, 
                status: newPax >= maxPax ? 'used' : 'active',
                checkInTime: serverTimestamp() 
            });
            document.getElementById('scanModal').classList.add('hidden');
            document.getElementById('scanResult').innerHTML = `<h3 class='text-success fw-bold'>‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!</h3>‡πÄ‡∏Ç‡πâ‡∏≤ ${amount} ‡∏Ñ‡∏ô (‡∏£‡∏ß‡∏° ${newPax}/${maxPax})`;
            setTimeout(() => html5QrcodeScanner.resume(), 2000); 
        } else {
            alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${remaining} ‡∏Ñ‡∏ô`);
        }
    };
    
    window.closeScanModal = () => {
        document.getElementById('scanModal').classList.add('hidden');
        document.getElementById('scanResult').innerHTML = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô...";
        html5QrcodeScanner.resume();
    };
    
    window.confirmScan = window.confirmModal;
    window.closeScanModal = window.closeScanModal;
    window.openTicketModal = window.openTicketModal;
    window.closeTicketModal = window.closeTicketModal;

    window.login = () => {
        signInWithEmailAndPassword(auth, document.getElementById('adminEmail').value, document.getElementById('adminPass').value)
            .catch((e) => alert("Login Failed: " + e.message));
    };
    window.logout = () => signOut(auth);
    onAuthStateChanged(auth, (user) => {
        document.getElementById('adminLoginContainer').classList.toggle('hidden', !!user);
        document.getElementById('adminContent').classList.toggle('hidden', !user);
    });

    window.loadBookingsAdmin = async () => {
        const list = document.getElementById('adminList');
        list.innerHTML = "<tr><td colspan='6' class='text-center text-dark'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>";
        
        try {
            const q = query(collection(db, "bookings"), orderBy("table", "asc"));
            const snapshot = await getDocs(q);
            list.innerHTML = "";
            
            if(snapshot.empty) {
                list.innerHTML = "<tr><td colspan='6' class='text-center text-muted'>- ‡∏ß‡πà‡∏≤‡∏á -</td></tr>";
                return;
            }

            snapshot.forEach((doc) => {
                const d = doc.data();
                const bookedTime = formatThaiDate(d.createdAt);
                const zoneColor = d.table.startsWith('VVIP') ? '#d63384' : '#ffc107';
                const payBadge = d.paymentMethod === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' ? '<span class="badge bg-success">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>' : '<span class="badge bg-primary">üè¶ ‡πÇ‡∏≠‡∏ô</span>';
                
                let slipBtn = '';
                if(d.slipUrl) {
                    slipBtn = `<br><button class="btn btn-sm btn-info mt-1" onclick="showSlip('${d.slipUrl}')">üìÑ ‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</button>`;
                }

                const payInfo = `${payBadge}${slipBtn}<br><small class="text-muted fst-italic">${d.paymentRef || '-'}</small>`;

                const currentPax = d.pax || 0;
                const maxPax = d.maxPax || 4;
                let paxBadge = `<span class="badge bg-warning text-dark">‡∏£‡∏≠ (${currentPax}/${maxPax})</span>`;
                if(currentPax >= maxPax) paxBadge = `<span class="badge bg-success">‡∏Ñ‡∏£‡∏ö (${currentPax}/${maxPax})</span>`;
                else if(currentPax > 0) paxBadge = `<span class="badge bg-info text-dark">‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (${currentPax}/${maxPax})</span>`;

                list.innerHTML += `
                    <tr>
                        <td class="fw-bold" style="font-size:1.1rem; color:${zoneColor}">${d.table}</td>
                        <td class="text-start text-dark">
                            <div class="fw-bold">${d.name}</div>
                            <small class="text-muted">${d.phone || ''}</small>
                        </td>
                        <td class="text-dark fw-bold">${bookedTime}</td>
                        <td class="text-dark">${payInfo}</td>
                        <td>${paxBadge}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-dark" onclick="showQr('${doc.id}')">QR</button>
                                <button class="btn btn-outline-danger" onclick="del('${doc.id}')">‡∏•‡∏ö</button>
                            </div>
                        </td>
                    </tr>`;
            });
        } catch(e) { console.error(e); }
    };
    
    window.showQr = (id) => {
        document.getElementById('qrModalBody').innerHTML = "";
        new QRCode(document.getElementById("qrModalBody"), { text: id, width: 200, height: 200 });
        qrModal.show();
    };

    window.showSlip = (url) => {
        document.getElementById('slipImagePreview').src = url;
        slipModal.show();
    };

    window.del = async (id) => { 
        if(confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) { 
            await deleteDoc(doc(db, "bookings", id)); 
            loadBookingsAdmin(); 
        }
    };
    
    window.del = window.del; window.showQr = window.showQr; window.showSlip = window.showSlip;
</script>

</body>
</html>
