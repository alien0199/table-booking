<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ - ‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤ ‡πÄ‡∏ü‡∏™‡∏ï‡∏¥‡∏ß‡∏±‡∏•</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;600&display=swap');

        body { font-family: 'Kanit', sans-serif; background-color: #000; color: #fff; padding-bottom: 50px; }
        .container { max-width: 500px; margin-top: 15px; }
        .hidden { display: none !important; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á (‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ) */
        .ticket-source {
            width: 350px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏™‡∏ß‡∏¢‡πÄ‡∏õ‡πä‡∏∞ */
            background: linear-gradient(180deg, #6a11cb 0%, #2575fc 100%);
            padding: 30px 20px;
            text-align: center;
            border-radius: 20px;
            color: white;
            position: fixed; top: -9999px; left: -9999px; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô */
        }
        
        .event-title { font-size: 28px; font-weight: bold; text-shadow: 2px 2px 0px #000; line-height: 1.2; }
        .event-sub { font-size: 24px; color: #ffeb3b; font-weight: bold; text-shadow: 1px 1px 0px #000; margin-bottom: 15px; }
        .ticket-header { background: rgba(0,0,0,0.3); display: inline-block; padding: 5px 20px; border-radius: 50px; font-size: 18px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.5); }
        
        /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏™‡πà QR Code */
        .qr-box { 
            background: #fff; 
            padding: 15px; 
            border-radius: 15px; 
            display: inline-block; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        .qr-box img { display: block; } /* ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏° */

        .cust-name { font-size: 26px; font-weight: bold; margin-bottom: 5px; }
        .table-number { 
            font-size: 48px; font-weight: bold; 
            background: #ffeb3b; color: #000; 
            display: inline-block; padding: 0px 30px; 
            border-radius: 15px; 
            box-shadow: 5px 5px 0px #000;
            transform: rotate(-2deg); /* ‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏ô‡∏¥‡∏î‡πÜ ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏ó‡πà */
            margin-top: 10px;
        }
        .footer-text { margin-top: 25px; font-size: 14px; opacity: 0.8; }

        /* ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
        #finalTicketImage { width: 100%; border-radius: 15px; box-shadow: 0 0 20px rgba(106, 17, 203, 0.5); border: 2px solid #444; }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á UI ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ */
        .nav-pills .nav-link.active { background: linear-gradient(90deg, #ff512f, #dd2476); border: none; }
        .nav-pills .nav-link { color: #aaa; background: #222; margin: 0 2px; }
        .form-control { background: #222; border: 1px solid #444; color: #fff; border-radius: 10px; height: 50px; font-size: 1.1rem; }
        .form-control::placeholder { color: #666; }
        .btn-main { background: linear-gradient(90deg, #11998e, #38ef7d); border: none; height: 55px; font-size: 1.2rem; font-weight: bold; color: #fff; border-radius: 12px; }
        .status-card { background: #222; border-radius: 10px; border: 1px solid #333; }
        .status-booked { color: #ffc107; border-top: 4px solid #ffc107; }
        .status-used { color: #2ecc71; border-top: 4px solid #2ecc71; }
    </style>
</head>
<body>

<div class="container">
    <h4 class="text-center mb-4 fw-bold text-white">‚ú® ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ <span style="color:#ffeb3b">‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤‡∏Ø</span></h4>

    <ul class="nav nav-pills nav-fill mb-4">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#create">üìù ‡∏à‡∏≠‡∏á</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#status" onclick="loadTableStatus()">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#scan">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin" onclick="checkAdminAccess()">‚öôÔ∏è Admin</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="create">
            <div class="card p-4 border-0 shadow-lg" style="background: #1a1a1a; border-radius: 20px;">
                <input type="text" id="custName" class="form-control mb-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏µ‡πà‡∏ö‡∏µ)">
                <input type="tel" id="custPhone" class="form-control mb-3" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
                <input type="text" id="tableNo" class="form-control mb-3" placeholder="‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞ (‡πÄ‡∏ä‡πà‡∏ô A1)">
                <input type="text" id="paymentRef" class="form-control mb-4" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô">
                
                <button onclick="addBooking()" id="btnSave" class="btn btn-main w-100 shadow">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£</button>
            </div>
            
            <div id="ticketResult" class="hidden mt-4 text-center animate__animated animate__fadeIn">
                <p class="text-success mb-2">üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! <b>‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏ü</b></p>
                <img id="finalTicketImage" src="" alt="Ticket">
                <button onclick="resetForm()" class="btn btn-outline-secondary w-100 mt-3 rounded-pill">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
            </div>
        </div>

        <div class="tab-pane fade" id="status">
            <button onclick="loadTableStatus()" class="btn btn-sm btn-secondary mb-3 w-100">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <div id="statusList" class="row g-2"></div>
        </div>

        <div class="tab-pane fade" id="scan">
            <div class="card p-3 border-0 bg-dark text-center">
                <div id="reader" style="border-radius: 15px; overflow: hidden;"></div>
                <div id="scanResult" class="mt-3 text-white">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô...</div>
                <button onclick="startScanner()" class="btn btn-primary mt-3 w-100 py-3 rounded-pill">üì∏ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                <button onclick="stopScanner()" class="btn btn-secondary mt-2 w-100 hidden" id="stopCamBtn">‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            </div>
        </div>

        <div class="tab-pane fade" id="admin">
            <div id="adminLoginForm" class="card p-4 bg-dark border-0">
                <input type="email" id="adminEmail" class="form-control mb-3" placeholder="Email">
                <input type="password" id="adminPass" class="form-control mb-3" placeholder="Password">
                <button onclick="login()" class="btn btn-light w-100 py-3 rounded-pill fw-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            <div id="adminContent" class="hidden">
                <div class="d-flex justify-content-between mb-3 text-white">
                    <span>Admin Mode</span>
                    <button onclick="logout()" class="btn btn-sm btn-danger">Logout</button>
                </div>
                <button onclick="loadBookingsAdmin()" class="btn btn-info w-100 mb-3">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <ul class="list-group" id="adminList"></ul>
            </div>
        </div>
    </div>
</div>

<div id="printableTicketSource" class="ticket-source">
    <div class="event-title">‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤ ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤</div>
    <div class="event-sub">‡πÇ‡∏û-‡∏≠‡∏≠‡∏Å ‡πÄ‡∏ü‡∏™‡∏ï‡∏¥‡∏ß‡∏±‡∏•</div>
    <div class="ticket-header">‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ VIP</div>
    
    <div class="qr-box">
        <img id="tempQrImg" src="" width="160" height="160" style="object-fit: contain;">
    </div>
    
    <div class="cust-name" id="ticketName">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
    <div class="table-number" id="ticketTable">VIP</div>
    <div class="footer-text">*‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</div>
</div>

<div id="rawQrContainer" style="display:none;"></div>

<div class="modal fade" id="qrModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-body text-center" id="qrModalBody"></div>
      <div class="modal-footer border-secondary p-1">
        <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD3s78zRwEHU5WAiSQIg78ZxWbS5QjXYws",
      authDomain: "my-booking-table-855b0.firebaseapp.com",
      projectId: "my-booking-table-855b0",
      storageBucket: "my-booking-table-855b0.firebasestorage.app",
      messagingSenderId: "589914860402",
      appId: "1:589914860402:web:d1033ebdd14b7f982c0beb",
      measurementId: "G-DFMJ4G668D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let html5QrcodeScanner = null;
    let qrModal = new bootstrap.Modal(document.getElementById('qrModal'));

    // --- 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á + ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å QR ‡∏´‡∏≤‡∏¢) ---
    window.addBooking = async () => {
        const btn = document.getElementById('btnSave');
        const name = document.getElementById('custName').value;
        const phone = document.getElementById('custPhone').value;
        const table = document.getElementById('tableNo').value.toUpperCase();
        const payRef = document.getElementById('paymentRef').value;

        if(!name || !table) return alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞");
        
        btn.disabled = true; btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£...";

        try {
            // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const docRef = await addDoc(collection(db, "bookings"), {
                name, phone, table, paymentRef: payRef, status: "booked", createdAt: serverTimestamp()
            });

            // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÉ‡∏ô Div ‡∏•‡∏±‡∏ö (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ Data URL)
            const rawContainer = document.getElementById("rawQrContainer");
            rawContainer.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤
            new QRCode(rawContainer, { 
                text: docRef.id, 
                width: 250, 
                height: 250,
                correctLevel: QRCode.CorrectLevel.H 
            });

            // 3. ‡∏£‡∏≠ QR ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∂‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡∏†‡∏≤‡∏û‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö
            setTimeout(async () => {
                const qrCanvas = rawContainer.querySelector('canvas');
                let qrDataUrl = "";
                
                if (qrCanvas) {
                    qrDataUrl = qrCanvas.toDataURL("image/png");
                    // ‡πÄ‡∏≠‡∏≤ Data URL ‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô <img> ‡∏Ç‡∏≠‡∏á‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á
                    document.getElementById('tempQrImg').src = qrDataUrl;
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ QR ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)
                    await updateDoc(docRef, { qrCodeDataUrl: qrDataUrl });
                }

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏ö‡∏±‡∏ï‡∏£
                document.getElementById('ticketName').innerText = name;
                document.getElementById('ticketTable').innerText = table;

                // 4. ‡∏£‡∏≠‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                setTimeout(() => {
                    html2canvas(document.getElementById("printableTicketSource"), {
                        scale: 2, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î
                        backgroundColor: null,
                        useCORS: true // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏Ç‡πâ‡∏≤‡∏°‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡πÑ‡∏î‡πâ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ)
                    }).then(canvas => {
                        // ‡πÄ‡∏≠‡∏≤‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå
                        document.getElementById('finalTicketImage').src = canvas.toDataURL("image/png");
                        document.getElementById('ticketResult').classList.remove('hidden');
                        
                        btn.disabled = false; btn.innerText = "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£";
                        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏•‡∏á‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏£‡∏π‡∏õ
                        document.getElementById('ticketResult').scrollIntoView({behavior: "smooth"});
                    });
                }, 300); // ‡∏£‡∏≠‡∏£‡∏π‡∏õ QR ‡πÅ‡∏õ‡∏∞‡∏•‡∏á‡∏ö‡∏±‡∏ï‡∏£
            }, 300); // ‡∏£‡∏≠ QR ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à

        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
            btn.disabled = false; btn.innerText = "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
        }
    };

    window.resetForm = () => {
        document.getElementById('custName').value = '';
        document.getElementById('custPhone').value = '';
        document.getElementById('tableNo').value = '';
        document.getElementById('paymentRef').value = '';
        document.getElementById('ticketResult').classList.add('hidden');
        document.getElementById('finalTicketImage').src = "";
    };

    // --- 2. ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞ ---
    window.loadTableStatus = async () => {
        const display = document.getElementById('statusList');
        display.innerHTML = "<div class='text-center text-white'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>";
        const q = query(collection(db, "bookings"), orderBy("table", "asc"));
        const snapshot = await getDocs(q);
        display.innerHTML = "";
        
        if(snapshot.empty) { display.innerHTML = "<div class='text-center text-muted'>‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</div>"; return; }
        
        snapshot.forEach((doc) => {
            const d = doc.data();
            const isUsed = d.status === 'used';
            const statusClass = isUsed ? 'status-used' : 'status-booked';
            const statusText = isUsed ? 'üü¢ ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß' : 'üü° ‡∏à‡∏≠‡∏á';
            
            display.innerHTML += `
                <div class="col-4 col-sm-3">
                    <div class="status-card p-2 text-center ${statusClass}">
                        <h4 class="fw-bold mb-0 text-white">${d.table}</h4>
                        <small class="d-block text-truncate text-secondary" style="font-size:0.8rem;">${d.name}</small>
                        <span class="badge bg-dark mt-1" style="font-size:0.7rem;">${statusText}</span>
                    </div>
                </div>`;
        });
    };

    // --- 3. ‡∏™‡πÅ‡∏Å‡∏ô ---
    window.startScanner = () => {
        document.getElementById('stopCamBtn').classList.remove('hidden');
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess, () => {});
    };
    window.stopScanner = () => {
        if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => {
            document.getElementById('reader').innerHTML = "";
            document.getElementById('stopCamBtn').classList.add('hidden');
        });
    };
    const onScanSuccess = async (decodedText) => {
        html5QrcodeScanner.pause();
        const resDiv = document.getElementById('scanResult');
        resDiv.innerHTML = "‚è≥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
        try {
            const docRef = doc(db, "bookings", decodedText);
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                const d = snap.data();
                if (d.status === 'booked') {
                    if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤?\n${d.name} (‡πÇ‡∏ï‡πä‡∏∞ ${d.table})`)) {
                        await updateDoc(docRef, { status: 'used', checkInTime: serverTimestamp() });
                        resDiv.innerHTML = `<h3 class='text-success fw-bold'>‚úÖ ‡∏ú‡πà‡∏≤‡∏ô!</h3>‡πÇ‡∏ï‡πä‡∏∞ ${d.table} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß`;
                    }
                } else { resDiv.innerHTML = `<h3 class='text-danger fw-bold'>‚ùå ‡∏ã‡πâ‡∏≥!</h3>QR ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß`; }
            } else { resDiv.innerHTML = `<h3 class='text-warning fw-bold'>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>`; }
        } catch (e) { resDiv.innerHTML = "Error: " + e.message; }
        setTimeout(() => html5QrcodeScanner.resume(), 2500);
    };

    // --- 4. Admin ---
    window.login = () => {
        signInWithEmailAndPassword(auth, document.getElementById('adminEmail').value, document.getElementById('adminPass').value)
            .catch((e) => alert("Login Failed: " + e.message));
    };
    window.logout = () => signOut(auth);
    onAuthStateChanged(auth, (user) => {
        document.getElementById('adminLoginForm').classList.toggle('hidden', !!user);
        document.getElementById('adminContent').classList.toggle('hidden', !user);
    });

    window.loadBookingsAdmin = async () => {
        const list = document.getElementById('adminList');
        list.innerHTML = "<li class='list-group-item bg-dark text-white'>Loading...</li>";
        const q = query(collection(db, "bookings"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        list.innerHTML = "";
        snapshot.forEach((doc) => {
            const d = doc.data();
            const qrBtn = d.qrCodeDataUrl ? `<button class="btn btn-sm btn-warning me-2" onclick="showQr('${d.qrCodeDataUrl}')">QR</button>` : '';
            list.innerHTML += `
                <li class="list-group-item bg-dark text-white border-secondary d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="text-warning">${d.table}</strong> : ${d.name}
                        <br><small class="text-muted">${d.status}</small>
                    </div>
                    <div>${qrBtn}<button class="btn btn-sm btn-danger" onclick="del('${doc.id}')">‡∏•‡∏ö</button></div>
                </li>`;
        });
    };
    
    window.showQr = (url) => {
        document.getElementById('qrModalBody').innerHTML = `<img src="${url}" style="width:100%; border-radius:10px;">`;
        qrModal.show();
    };

    window.del = async (id) => { if(confirm("‡∏•‡∏ö?")) { await deleteDoc(doc(db, "bookings", id)); loadBookingsAdmin(); }};
    
    window.del = window.del; window.showQr = window.showQr;
</script>

</body>
</html>
