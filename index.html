<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ (Staff & Admin)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; }
        .container { max-width: 600px; margin-top: 15px; padding-bottom: 50px; }
        .hidden { display: none !important; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; }
        .card-ticket { border: 2px dashed #000; padding: 20px; background: #fff; text-align: center; margin-top: 20px; border-radius: 10px;}
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞ */
        .status-card { transition: transform 0.2s; border: none; }
        .status-booked { background-color: #fff3cd; border-left: 5px solid #ffc107; color: #856404; }
        .status-used { background-color: #d1e7dd; border-left: 5px solid #198754; color: #0f5132; }
        .badge-table { font-size: 1.2rem; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h3 class="text-center mb-3 fw-bold text-dark">üçΩÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞</h3>

    <ul class="nav nav-pills nav-fill mb-3 bg-white p-2 rounded shadow-sm" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#create">üìù ‡∏à‡∏≠‡∏á</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#status" onclick="loadTableStatus()">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#scan">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin" onclick="checkAdminAccess()">‚öôÔ∏è Admin</button></li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="create">
            <div class="card p-3 shadow-sm border-0">
                <h5 class="mb-3 text-secondary">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h5>
                <input type="text" id="custName" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                <input type="tel" id="custPhone" class="form-control mb-2" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
                <input type="text" id="tableNo" class="form-control mb-2" placeholder="‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞ (‡πÄ‡∏ä‡πà‡∏ô A1, B2)">
                <input type="text" id="paymentRef" class="form-control mb-2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô">
                <button onclick="addBooking()" class="btn btn-success w-100 py-2 fw-bold">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
            </div>
            
            <div id="ticketResult" class="hidden mt-3">
                <div class="card-ticket shadow">
                    <h4>‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞</h4>
                    <div id="qrcodeDisplay" class="d-flex justify-content-center my-3"></div>
                    <h5 id="ticketName" class="text-primary"></h5>
                    <div class="mt-2">‡πÇ‡∏ï‡πä‡∏∞: <span id="ticketTable" class="badge bg-dark fs-3"></span></div>
                    <small class="text-muted d-block mt-2">‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</small>
                </div>
                <button onclick="window.print()" class="btn btn-outline-dark w-100 mt-2">‡∏û‡∏¥‡∏°‡∏û‡πå / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ</button>
                <button onclick="resetForm()" class="btn btn-link w-100 mt-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>

        <div class="tab-pane fade" id="status">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted small">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdate">-</span></span>
                <button onclick="loadTableStatus()" class="btn btn-sm btn-info text-white">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
            <div id="statusList" class="row g-2"></div>
        </div>

        <div class="tab-pane fade" id="scan">
            <div class="card p-3 text-center shadow-sm border-0">
                <div id="reader"></div>
                <div id="scanResult" class="mt-3 fw-bold p-2 rounded bg-light">‡∏£‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á...</div>
                <button onclick="startScanner()" class="btn btn-primary mt-2">üì∏ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                <button onclick="stopScanner()" class="btn btn-secondary mt-2 hidden" id="stopCamBtn">‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            </div>
        </div>

        <div class="tab-pane fade" id="admin">
            <div id="adminLoginForm" class="card p-4 text-center border-0 shadow-sm">
                <h5>üîí ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô</h5>
                <p class="text-muted small">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                <input type="email" id="adminEmail" class="form-control mb-2" placeholder="Email">
                <input type="password" id="adminPass" class="form-control mb-2" placeholder="Password">
                <button onclick="login()" class="btn btn-dark w-100">Login</button>
            </div>

            <div id="adminContent" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge bg-danger">Admin Mode</span>
                    <button onclick="logout()" class="btn btn-sm btn-outline-secondary">Logout</button>
                </div>
                <button onclick="loadBookingsAdmin()" class="btn btn-sm btn-outline-primary mb-2 w-100">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö)</button>
                <ul class="list-group" id="adminList"></ul>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
    const firebaseConfig = {
      apiKey: "AIzaSyD3s78zRwEHU5WAiSQIg78ZxWbS5QjXYws",
      authDomain: "my-booking-table-855b0.firebaseapp.com",
      projectId: "my-booking-table-855b0",
      storageBucket: "my-booking-table-855b0.firebasestorage.app",
      messagingSenderId: "589914860402",
      appId: "1:589914860402:web:d1033ebdd14b7f982c0beb",
      measurementId: "G-DFMJ4G668D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let html5QrcodeScanner = null;

    // --- 1. ‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ ---
    window.addBooking = async () => {
        const name = document.getElementById('custName').value;
        const phone = document.getElementById('custPhone').value;
        const table = document.getElementById('tableNo').value.toUpperCase(); // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà
        const payRef = document.getElementById('paymentRef').value;

        if(!name || !table) return alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞");

        // (Option) ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÇ‡∏ï‡πä‡∏∞‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏´‡∏° (‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢)
        // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÇ‡∏ï‡πä‡∏∞‡∏ã‡πâ‡∏≥ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î Query ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ
        
        try {
            const docRef = await addDoc(collection(db, "bookings"), {
                name, phone, table, paymentRef: payRef, status: "booked", createdAt: serverTimestamp()
            });

            document.getElementById('qrcodeDisplay').innerHTML = "";
            new QRCode(document.getElementById("qrcodeDisplay"), { text: docRef.id, width: 160, height: 160 });
            document.getElementById('ticketName').innerText = name;
            document.getElementById('ticketTable').innerText = table;
            document.getElementById('ticketResult').classList.remove('hidden');
            alert("‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠");
        } catch (e) { alert("Error: " + e.message); }
    };

    window.resetForm = () => {
        document.getElementById('custName').value = '';
        document.getElementById('tableNo').value = '';
        document.getElementById('ticketResult').classList.add('hidden');
    };

    // --- 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞ (‡πÉ‡∏´‡∏°‡πà!) ---
    window.loadTableStatus = async () => {
        const display = document.getElementById('statusList');
        display.innerHTML = "<div class='text-center p-3'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>";
        
        try {
            const q = query(collection(db, "bookings"), orderBy("table", "asc")); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞
            const snapshot = await getDocs(q);
            
            display.innerHTML = "";
            if(snapshot.empty) {
                display.innerHTML = "<div class='text-center text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>";
                return;
            }

            snapshot.forEach((doc) => {
                const d = doc.data();
                const isUsed = d.status === 'used';
                const cardClass = isUsed ? 'status-used' : 'status-booked';
                const statusText = isUsed ? 'üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : 'üü° ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠)';
                
                const card = `
                    <div class="col-6 col-md-4">
                        <div class="card p-2 shadow-sm status-card ${cardClass}">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-dark badge-table">${d.table}</span>
                                <small style="font-size: 0.7rem;">${statusText}</small>
                            </div>
                            <div class="mt-2 text-start">
                                <strong>${d.name}</strong><br>
                                <small class="text-muted">${d.phone || '-'}</small>
                            </div>
                        </div>
                    </div>
                `;
                display.innerHTML += card;
            });
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
            const now = new Date();
            document.getElementById('lastUpdate').innerText = now.toLocaleTimeString();

        } catch (e) {
            console.error(e);
            display.innerHTML = "<div class='alert alert-danger'>‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + e.message + "</div>";
        }
    };

    // --- 3. ‡∏™‡πÅ‡∏Å‡∏ô QR ---
    window.startScanner = () => {
        document.getElementById('stopCamBtn').classList.remove('hidden');
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess, () => {});
    };

    window.stopScanner = () => {
        if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => {
            document.getElementById('reader').innerHTML = "";
            document.getElementById('stopCamBtn').classList.add('hidden');
        });
    };

    const onScanSuccess = async (decodedText) => {
        html5QrcodeScanner.pause();
        const resDiv = document.getElementById('scanResult');
        resDiv.innerHTML = "‚è≥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
        
        try {
            const docRef = doc(db, "bookings", decodedText);
            const snap = await getDoc(docRef);
            
            if (snap.exists()) {
                const d = snap.data();
                if (d.status === 'booked') {
                    if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô?\n‡∏Ñ‡∏∏‡∏ì: ${d.name}\n‡πÇ‡∏ï‡πä‡∏∞: ${d.table}`)) {
                        await updateDoc(docRef, { status: 'used', checkInTime: serverTimestamp() });
                        resDiv.innerHTML = `<div class='alert alert-success'>‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÇ‡∏ï‡πä‡∏∞ ${d.table} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>`;
                    }
                } else {
                    resDiv.innerHTML = `<div class='alert alert-danger'>‚ùå ‡∏ã‡πâ‡∏≥! QR ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</div>`;
                }
            } else {
                resDiv.innerHTML = `<div class='alert alert-warning'>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</div>`;
            }
        } catch (e) { resDiv.innerHTML = "Error: " + e.message; }
        
        setTimeout(() => html5QrcodeScanner.resume(), 2500);
    };

    // --- 4. Admin (Login & Delete) ---
    window.login = () => {
        const email = document.getElementById('adminEmail').value;
        const pass = document.getElementById('adminPass').value;
        signInWithEmailAndPassword(auth, email, pass)
            .then(() => alert("Admin Login Success"))
            .catch((e) => alert("Login Failed: " + e.message));
    };
    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('adminLoginForm').classList.add('hidden');
            document.getElementById('adminContent').classList.remove('hidden');
            loadBookingsAdmin();
        } else {
            document.getElementById('adminLoginForm').classList.remove('hidden');
            document.getElementById('adminContent').classList.add('hidden');
        }
    });

    window.loadBookingsAdmin = async () => {
        const list = document.getElementById('adminList');
        list.innerHTML = "<li>Loading...</li>";
        const q = query(collection(db, "bookings"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        list.innerHTML = "";
        snapshot.forEach((doc) => {
            const d = doc.data();
            list.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${d.name} (${d.table})</strong><br>
                        <small>${d.status}</small>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="del('${doc.id}')">‡∏•‡∏ö</button>
                </li>`;
        });
    };
    window.del = async (id) => {
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£?")) { await deleteDoc(doc(db, "bookings", id)); loadBookingsAdmin(); }
    };
    window.del = window.del;
</script>

</body>
</html>
