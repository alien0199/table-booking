<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ - ‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤ ‡πÄ‡∏ü‡∏™‡∏ï‡∏¥‡∏ß‡∏±‡∏•</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å */
        body { font-family: 'Sarabun', sans-serif; background-color: #121212; color: #eee; }
        .container { max-width: 600px; margin-top: 15px; padding-bottom: 80px; }
        .hidden { display: none !important; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á (‡∏ò‡∏µ‡∏°‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï) */
        .card-ticket-box {
            /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏•‡πà‡∏™‡∏µ ‡∏°‡πà‡∏ß‡∏á-‡∏ä‡∏°‡∏û‡∏π-‡∏™‡πâ‡∏° */
            background: linear-gradient(135deg, #4a00e0, #8e2de2, #ff512f);
            color: #fff;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            border: 3px solid #fff;
            position: relative;
            overflow: hidden;
        }
        /* ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á */
        .card-ticket-box::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: repeating-linear-gradient(transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px);
            transform: rotate(45deg);
            pointer-events: none;
        }
        .event-title { font-size: 1.8rem; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); margin-bottom: 0; }
        .event-subtitle { font-size: 1.4rem; font-weight: bold; color: #ffeb3b; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        .ticket-label { font-size: 1.1rem; margin-top: 15px; font-weight: bold; }
        /* ‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏£‡∏≠‡∏ö QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
        #qrcodeWrapper { background: #fff; padding: 15px; border-radius: 10px; display: inline-block; margin: 15px 0; }
        .cust-name { font-size: 1.5rem; font-weight: bold; color: #fff; }
        .table-badge { font-size: 2rem; background-color: #ffeb3b; color: #000; padding: 5px 20px; border-radius: 50px; box-shadow: 0 5px 15px rgba(255, 235, 59, 0.4); }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ */
        .nav-pills .nav-link.active { background-color: #ff512f; }
        .nav-pills .nav-link { color: #ddd; }
        .form-control { background-color: #2c2c2c; border: 1px solid #444; color: #fff; }
        .form-control::placeholder { color: #bbb; }
        .status-card { background-color: #2c2c2c; }
        .status-booked { border-left: 5px solid #ffc107; color: #ffc107; }
        .status-used { border-left: 5px solid #198754; color: #198754; }
        /* ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ */
        #finalTicketImage { width: 100%; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div class="container">
    <h3 class="text-center mb-3 fw-bold" style="color: #ff512f;">üé∏ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ ‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤‡∏Ø</h3>

    <ul class="nav nav-pills nav-fill mb-3 p-2 rounded shadow-sm" style="background: #2c2c2c;" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#create">üìù ‡∏à‡∏≠‡∏á</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#status" onclick="loadTableStatus()">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#scan">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin" onclick="checkAdminAccess()">‚öôÔ∏è Admin</button></li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="create">
            <div class="card p-3 shadow-sm border-0" style="background: #2c2c2c;">
                <h5 class="mb-3 text-light">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h5>
                <input type="text" id="custName" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                <input type="tel" id="custPhone" class="form-control mb-2" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
                <input type="text" id="tableNo" class="form-control mb-2" placeholder="‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞ (‡πÄ‡∏ä‡πà‡∏ô A1, B2)">
                <input type="text" id="paymentRef" class="form-control mb-2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô">
                <button onclick="addBooking()" id="btnSaveBooking" class="btn btn-success w-100 py-2 fw-bold" style="background: linear-gradient(to right, #198754, #20c997); border: none;">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
            </div>
            
            <div id="ticketResult" class="hidden mt-4 text-center">
                <div class="alert alert-info p-2 mb-2">‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! <b>‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>
                <img id="finalTicketImage" src="" alt="‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞">
                <button onclick="resetForm()" class="btn btn-outline-light w-100 mt-3">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
            </div>

            <div id="printableTicketSource" style="position: fixed; top: -9999px; left: -9999px;">
                <div class="card-ticket-box" id="ticketContentBox">
                    <div class="event-title">‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤ ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤</div>
                    <div class="event-subtitle">‡πÇ‡∏û-‡∏≠‡∏≠‡∏Å ‡πÄ‡∏ü‡∏™‡∏ï‡∏¥‡∏ß‡∏±‡∏•</div>
                    <div class="ticket-label">‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ VIP</div>
                    <div id="qrcodeWrapper">
                        <div id="qrcodeDisplay"></div>
                    </div>
                    <div class="cust-name" id="ticketName"></div>
                    <div class="mt-3">
                        <span class="badge table-badge" id="ticketTable"></span>
                    </div>
                    <small class="d-block mt-3" style="color: rgba(255,255,255,0.8);">*‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</small>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="status">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted small">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdate">-</span></span>
                <button onclick="loadTableStatus()" class="btn btn-sm btn-info text-white">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
            <div id="statusList" class="row g-2"></div>
        </div>

        <div class="tab-pane fade" id="scan">
            <div class="card p-3 text-center shadow-sm border-0" style="background: #2c2c2c;">
                <div id="reader" style="background: #000;"></div>
                <div id="scanResult" class="mt-3 fw-bold p-2 rounded text-light">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô...</div>
                <button onclick="startScanner()" class="btn btn-primary mt-2 w-100 py-2" style="background: #ff512f; border:none;">üì∏ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                <button onclick="stopScanner()" class="btn btn-secondary mt-2 hidden w-100" id="stopCamBtn">‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            </div>
        </div>

        <div class="tab-pane fade" id="admin">
            <div id="adminLoginForm" class="card p-4 text-center border-0 shadow-sm" style="background: #2c2c2c;">
                <h5 class="text-light">üîí ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô</h5>
                <input type="email" id="adminEmail" class="form-control mb-2" placeholder="Email">
                <input type="password" id="adminPass" class="form-control mb-2" placeholder="Password">
                <button onclick="login()" class="btn btn-light w-100 fw-bold">Login</button>
            </div>

            <div id="adminContent" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge bg-danger">Admin Mode</span>
                    <button onclick="logout()" class="btn btn-sm btn-outline-light">Logout</button>
                </div>
                <button onclick="loadBookingsAdmin()" class="btn btn-sm btn-outline-info mb-3 w-100">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
                <ul class="list-group" id="adminList"></ul>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="qrModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background: #2c2c2c; color: #fff;">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">QR Code ‡∏™‡∏≥‡∏£‡∏≠‡∏á</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center" id="qrModalBody">
        </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD3s78zRwEHU5WAiSQIg78ZxWbS5QjXYws",
      authDomain: "my-booking-table-855b0.firebaseapp.com",
      projectId: "my-booking-table-855b0",
      storageBucket: "my-booking-table-855b0.firebasestorage.app",
      messagingSenderId: "589914860402",
      appId: "1:589914860402:web:d1033ebdd14b7f982c0beb",
      measurementId: "G-DFMJ4G668D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let html5QrcodeScanner = null;
    let qrModal = new bootstrap.Modal(document.getElementById('qrModal'));

    // --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ---
    window.addBooking = async () => {
        const btn = document.getElementById('btnSaveBooking');
        const name = document.getElementById('custName').value;
        const phone = document.getElementById('custPhone').value;
        const table = document.getElementById('tableNo').value.toUpperCase();
        const payRef = document.getElementById('paymentRef').value;

        if(!name || !table) return alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞");
        
        btn.disabled = true; btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ...";

        try {
            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤ ID
            const docRef = await addDoc(collection(db, "bookings"), {
                name, phone, table, paymentRef: payRef, status: "booked", createdAt: serverTimestamp()
            });

            // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÉ‡∏™‡πà‡πÉ‡∏ô HTML ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà
            const qrContainer = document.getElementById("qrcodeDisplay");
            qrContainer.innerHTML = "";
            new QRCode(qrContainer, { text: docRef.id, width: 150, height: 150, correctLevel: QRCode.CorrectLevel.H });
            
            document.getElementById('ticketName').innerText = name;
            document.getElementById('ticketTable').innerText = table;

            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ QR Code ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà
            setTimeout(async () => {
                 // 3. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û QR Code ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
                const qrCanvas = qrContainer.querySelector('canvas');
                let qrDataUrl = "";
                if (qrCanvas) {
                    qrDataUrl = qrCanvas.toDataURL("image/png");
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ QR ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏£‡∏≠‡∏á)
                    await updateDoc(docRef, { qrCodeDataUrl: qrDataUrl });
                }

                // 4. ‡πÉ‡∏ä‡πâ html2canvas ‡πÅ‡∏õ‡∏•‡∏á HTML ‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                html2canvas(document.querySelector("#ticketContentBox"), {
                    scale: 2, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ
                    backgroundColor: null // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™‡∏ï‡∏≤‡∏° CSS
                }).then(canvas => {
                    // ‡πÄ‡∏≠‡∏≤‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
                    document.getElementById('finalTicketImage').src = canvas.toDataURL("image/png");
                    document.getElementById('ticketResult').classList.remove('hidden');
                    
                    btn.disabled = false; btn.innerText = "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
                    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                });
            }, 500); // ‡∏£‡∏≠ 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏´‡πâ QR render ‡πÄ‡∏™‡∏£‡πá‡∏à

        } catch (e) {
            console.error(e);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
            btn.disabled = false; btn.innerText = "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
        }
    };

    window.resetForm = () => {
        document.getElementById('custName').value = '';
        document.getElementById('custPhone').value = '';
        document.getElementById('tableNo').value = '';
        document.getElementById('paymentRef').value = '';
        document.getElementById('ticketResult').classList.add('hidden');
        document.getElementById('finalTicketImage').src = "";
    };

    // --- 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ---
    window.loadTableStatus = async () => {
        const display = document.getElementById('statusList');
        display.innerHTML = "<div class='text-center p-3 text-light'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>";
        try {
            const q = query(collection(db, "bookings"), orderBy("table", "asc"));
            const snapshot = await getDocs(q);
            display.innerHTML = "";
            if(snapshot.empty) { display.innerHTML = "<div class='text-center text-muted'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>"; return; }
            snapshot.forEach((doc) => {
                const d = doc.data();
                const isUsed = d.status === 'used';
                const cardClass = isUsed ? 'status-used' : 'status-booked';
                const statusText = isUsed ? 'üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß' : 'üü° ‡∏£‡∏≠';
                display.innerHTML += `
                    <div class="col-6 col-md-4">
                        <div class="card p-2 shadow-sm ${cardClass}" style="background:#2c2c2c;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-light text-dark fs-5">${d.table}</span>
                                <small class="text-light">${statusText}</small>
                            </div>
                            <div class="text-light"><strong>${d.name}</strong></div>
                        </div>
                    </div>`;
            });
            document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString();
        } catch (e) { display.innerHTML = "<div class='text-danger'>Error: " + e.message + "</div>"; }
    };

    // --- 3. ‡∏™‡πÅ‡∏Å‡∏ô ---
    window.startScanner = () => {
        document.getElementById('stopCamBtn').classList.remove('hidden');
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess, () => {});
    };
    window.stopScanner = () => {
        if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => {
            document.getElementById('reader').innerHTML = "";
            document.getElementById('stopCamBtn').classList.add('hidden');
        });
    };
    const onScanSuccess = async (decodedText) => {
        html5QrcodeScanner.pause();
        const resDiv = document.getElementById('scanResult');
        resDiv.innerHTML = "‚è≥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
        try {
            const docRef = doc(db, "bookings", decodedText);
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                const d = snap.data();
                if (d.status === 'booked') {
                    if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô?\n${d.name} (‡πÇ‡∏ï‡πä‡∏∞ ${d.table})`)) {
                        await updateDoc(docRef, { status: 'used', checkInTime: serverTimestamp() });
                        resDiv.innerHTML = `<div class='alert alert-success'>‚úÖ ‡∏ú‡πà‡∏≤‡∏ô! ‡πÇ‡∏ï‡πä‡∏∞ ${d.table} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>`;
                    }
                } else { resDiv.innerHTML = `<div class='alert alert-danger'>‚ùå ‡∏ã‡πâ‡∏≥! ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</div>`; }
            } else { resDiv.innerHTML = `<div class='alert alert-warning'>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`; }
        } catch (e) { resDiv.innerHTML = "Error: " + e.message; }
        setTimeout(() => html5QrcodeScanner.resume(), 2500);
    };

    // --- 4. Admin ---
    window.login = () => {
        signInWithEmailAndPassword(auth, document.getElementById('adminEmail').value, document.getElementById('adminPass').value)
            .catch((e) => alert("Login Failed: " + e.message));
    };
    window.logout = () => signOut(auth);
    onAuthStateChanged(auth, (user) => {
        document.getElementById('adminLoginForm').classList.toggle('hidden', !!user);
        document.getElementById('adminContent').classList.toggle('hidden', !user);
        if(user) loadBookingsAdmin();
    });

    window.loadBookingsAdmin = async () => {
        const list = document.getElementById('adminList');
        list.innerHTML = "<li class='list-group-item bg-dark text-light'>Loading...</li>";
        const q = query(collection(db, "bookings"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        list.innerHTML = "";
        snapshot.forEach((doc) => {
            const d = doc.data();
            // ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π QR ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
            const qrButton = d.qrCodeDataUrl ? `<button class="btn btn-sm btn-outline-warning me-2" onclick="showQr('${d.qrCodeDataUrl}')">üîé ‡∏î‡∏π QR</button>` : '';
            list.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center" style="background: #2c2c2c; color: #fff; border-color: #444;">
                    <div><strong>${d.name} (${d.table})</strong><br><small>${d.status}</small></div>
                    <div>
                        ${qrButton}
                        <button class="btn btn-sm btn-danger" onclick="del('${doc.id}')">‡∏•‡∏ö</button>
                    </div>
                </li>`;
        });
    };
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Modal ‡∏£‡∏π‡∏õ QR Code (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin)
    window.showQr = (imgUrl) => {
        document.getElementById('qrModalBody').innerHTML = `<img src="${imgUrl}" class="img-fluid" style="border: 5px solid #fff; border-radius: 10px;">`;
        qrModal.show();
    };

    window.del = async (id) => { if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?")) { await deleteDoc(doc(db, "bookings", id)); loadBookingsAdmin(); }};
    
    // Expose functions to global scope
    window.del = window.del; window.showQr = window.showQr;
</script>

</body>
</html>
