<script type="module">
    // --- ส่วนนำเข้าเครื่องมือ (ห้ามแก้ไข) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- ตั้งค่า Firebase (ผมใส่รหัสของคุณให้แล้ว) ---
    const firebaseConfig = {
        apiKey: "AIzaSyD3s78zRwEHU5WAiSQIg78ZxWbS5QjXYws",
        authDomain: "my-booking-table-855b0.firebaseapp.com",
        projectId: "my-booking-table-855b0",
        storageBucket: "my-booking-table-855b0.firebasestorage.app",
        messagingSenderId: "589914860402",
        appId: "1:589914860402:web:d1033ebdd14b7f982c0beb",
        measurementId: "G-DFMJ4G668D"
    };

    // เริ่มต้นระบบ
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let html5QrcodeScanner = null;

    // --- ระบบ Login ---
    window.login = () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        signInWithEmailAndPassword(auth, email, pass)
            .then(() => alert("ยินดีต้อนรับ Admin"))
            .catch((error) => alert("Login ผิดพลาด: " + error.message));
    };

    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            loadBookings();
        } else {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }
    });

    // --- 1. ฟังก์ชันสร้างการจอง ---
    window.addBooking = async () => {
        const name = document.getElementById('custName').value;
        const phone = document.getElementById('custPhone').value;
        const table = document.getElementById('tableNo').value;
        const payRef = document.getElementById('paymentRef').value;

        if(!name || !table) return alert("กรุณาใส่ชื่อและเลขโต๊ะ");

        try {
            const docRef = await addDoc(collection(db, "bookings"), {
                name: name,
                phone: phone,
                table: table,
                paymentRef: payRef,
                status: "booked", // สถานะเริ่มต้น
                createdAt: serverTimestamp()
            });

            // สร้าง QR Code
            document.getElementById('qrcodeDisplay').innerHTML = "";
            new QRCode(document.getElementById("qrcodeDisplay"), {
                text: docRef.id, 
                width: 150, height: 150
            });

            document.getElementById('ticketName').innerText = name;
            document.getElementById('ticketTable').innerText = table;
            document.getElementById('ticketResult').classList.remove('hidden');

            alert("สร้างรายการสำเร็จ!");
            loadBookings();
        } catch (e) {
            console.error("Error: ", e);
            alert("เกิดข้อผิดพลาดในการบันทึก: " + e.message);
        }
    };

    window.resetForm = () => {
        document.getElementById('custName').value = '';
        document.getElementById('custPhone').value = '';
        document.getElementById('tableNo').value = '';
        document.getElementById('paymentRef').value = '';
        document.getElementById('ticketResult').classList.add('hidden');
    }

    // --- 2. ฟังก์ชันสแกน QR ---
    window.startScanner = () => {
        document.getElementById('stopCamBtn').classList.remove('hidden');
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: 250 },
            onScanSuccess,
            onScanFailure
        );
    };

    window.stopScanner = () => {
        if(html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                document.getElementById('reader').innerHTML = "";
                document.getElementById('stopCamBtn').classList.add('hidden');
            });
        }
    }

    const onScanSuccess = async (decodedText, decodedResult) => {
        html5QrcodeScanner.pause();
        const bookingId = decodedText;
        const resultDiv = document.getElementById('scanResult');
        resultDiv.innerHTML = "กำลังตรวจสอบ...";

        try {
            const docRef = doc(db, "bookings", bookingId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.status === "booked") {
                    if(confirm(`ยืนยันลูกค้า?\nชื่อ: ${data.name}\nโต๊ะ: ${data.table}`)) {
                        await updateDoc(docRef, { status: "used", checkInTime: serverTimestamp() });
                        resultDiv.innerHTML = `<div class='alert alert-success'>✅ ผ่าน! เช็คอินเรียบร้อย<br>โต๊ะ: ${data.table}</div>`;
                        loadBookings();
                    }
                } else if (data.status === "used") {
                    resultDiv.innerHTML = `<div class='alert alert-danger'>❌ ไม่ผ่าน! QR นี้ใช้ไปแล้ว</div>`;
                }
            } else {
                resultDiv.innerHTML = `<div class='alert alert-warning'>⚠️ ไม่พบข้อมูลการจอง</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = "เกิดข้อผิดพลาด: " + error.message;
        }
        setTimeout(() => html5QrcodeScanner.resume(), 3000);
    }

    function onScanFailure(error) {}

    // --- 3. ฟังก์ชันโหลดรายการและลบ ---
    window.loadBookings = async () => {
        const listTable = document.getElementById('bookingListTable');
        listTable.innerHTML = "<tr><td colspan='3'>กำลังโหลด...</td></tr>";
        
        const q = query(collection(db, "bookings"), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);
        
        listTable.innerHTML = "";
        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id;
            const statusColor = data.status === 'used' ? 'text-success' : 'text-primary';
            const statusText = data.status === 'used' ? 'ใช้แล้ว' : 'รอใช้งาน';
            
            const row = `
                <tr>
                    <td>
                        <strong>${data.name}</strong><br>
                        <small>โต๊ะ: ${data.table}</small><br>
                        <small class="text-muted">${data.paymentRef || ''}</small>
                    </td>
                    <td class="${statusColor}">${statusText}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteBooking('${id}')">ลบ</button>
                    </td>
                </tr>
            `;
            listTable.innerHTML += row;
        });
    };

    window.deleteBooking = async (id) => {
        if(confirm("ต้องการลบข้อมูลนี้ถาวร?")) {
            await deleteDoc(doc(db, "bookings", id));
            loadBookings();
        }
    };
</script>
