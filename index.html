<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการจองโต๊ะ (Admin Only)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; }
        .container { max-width: 600px; margin-top: 20px; }
        .hidden { display: none; }
        #reader { width: 100%; }
        .card-ticket { border: 2px dashed #000; padding: 20px; background: #fff; text-align: center; margin-top: 20px;}
        .status-used { color: red; font-weight: bold; }
        .status-ok { color: green; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h3 class="text-center mb-4">ระบบจัดการจองโต๊ะ</h3>

    <div id="loginSection" class="card p-4">
        <h4>เข้าสู่ระบบแอดมิน</h4>
        <input type="email" id="email" class="form-control mb-2" placeholder="Email (เช่น ping@pong.com)">
        <input type="password" id="password" class="form-control mb-2" placeholder="Password">
        <button onclick="login()" class="btn btn-primary w-100">เข้าสู่ระบบ</button>
    </div>

    <div id="adminDashboard" class="hidden">
        <div class="d-flex justify-content-between mb-3">
            <span>สวัสดี, Admin</span>
            <button onclick="logout()" class="btn btn-sm btn-secondary">ออกจากระบบ</button>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button">สร้างการจอง</button></li>
            <li class="nav-item"><button class="nav-link" id="scan-tab" data-bs-toggle="tab" data-bs-target="#scan" type="button">สแกนเข้างาน</button></li>
            <li class="nav-item"><button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" onclick="loadBookings()">รายการจอง</button></li>
        </ul>

        <div class="tab-content pt-3" id="myTabContent">
            
            <div class="tab-pane fade show active" id="create">
                <div class="card p-3">
                    <h5>ข้อมูลลูกค้า</h5>
                    <input type="text" id="custName" class="form-control mb-2" placeholder="ชื่อลูกค้า">
                    <input type="tel" id="custPhone" class="form-control mb-2" placeholder="เบอร์โทร">
                    <input type="text" id="tableNo" class="form-control mb-2" placeholder="เลขโต๊ะ / โซน">
                    <input type="text" id="paymentRef" class="form-control mb-2" placeholder="เลขอ้างอิงโอนเงิน">
                    <button onclick="addBooking()" class="btn btn-success w-100">บันทึกและสร้าง QR Code</button>
                </div>
                
                <div id="ticketResult" class="hidden">
                    <div class="card-ticket" id="printableTicket">
                        <h4>บัตรจองโต๊ะ</h4>
                        <div id="qrcodeDisplay" class="d-flex justify-content-center my-3"></div>
                        <p><strong>ชื่อ:</strong> <span id="ticketName"></span></p>
                        <p><strong>โต๊ะ:</strong> <span id="ticketTable"></span></p>
                        <small class="text-muted">โปรดแสดง QR นี้ให้พนักงานสแกน</small>
                    </div>
                    <button onclick="window.print()" class="btn btn-outline-dark w-100 mt-2">พิมพ์ / บันทึกเป็น PDF</button>
                    <button onclick="resetForm()" class="btn btn-link w-100 mt-2">จองให้คนต่อไป</button>
                </div>
            </div>

            <div class="tab-pane fade" id="scan">
                <div class="card p-3 text-center">
                    <div id="reader"></div>
                    <div id="scanResult" class="mt-3"></div>
                    <button onclick="startScanner()" class="btn btn-primary mt-2">เริ่มกล้อง</button>
                    <button onclick="stopScanner()" class="btn btn-danger mt-2 hidden" id="stopCamBtn">ปิดกล้อง</button>
                </div>
            </div>

            <div class="tab-pane fade" id="list">
                <button onclick="loadBookings()" class="btn btn-sm btn-info mb-2">รีเฟรชข้อมูล</button>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm" style="font-size: 0.9rem;">
                        <thead class="table-light">
                            <tr>
                                <th>ชื่อ/โต๊ะ</th>
                                <th>สถานะ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="bookingListTable">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    // --- ตั้งค่า Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // รหัส Firebase ของคุณ (ใส่ให้แล้ว)
    const firebaseConfig = {
      apiKey: "AIzaSyD3s78zRwEHU5WAiSQIg78ZxWbS5QjXYws",
      authDomain: "my-booking-table-855b0.firebaseapp.com",
      projectId: "my-booking-table-855b0",
      storageBucket: "my-booking-table-855b0.firebasestorage.app",
      messagingSenderId: "589914860402",
      appId: "1:589914860402:web:d1033ebdd14b7f982c0beb",
      measurementId: "G-DFMJ4G668D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let html5QrcodeScanner = null;

    // --- ระบบ Login ---
    window.login = () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        signInWithEmailAndPassword(auth, email, pass)
            .then(() => alert("ยินดีต้อนรับ Admin"))
            .catch((error) => alert("Login ผิดพลาด: " + error.message));
    };

    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            loadBookings();
        } else {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }
    });

    // --- 1. ฟังก์ชันสร้างการจอง ---
    window.addBooking = async () => {
        const name = document.getElementById('custName').value;
        const phone = document.getElementById('custPhone').value;
        const table = document.getElementById('tableNo').value;
        const payRef = document.getElementById('paymentRef').value;

        if(!name || !table) return alert("กรุณาใส่ชื่อและเลขโต๊ะ");

        try {
            const docRef = await addDoc(collection(db, "bookings"), {
                name: name,
                phone: phone,
                table: table,
                paymentRef: payRef,
                status: "booked", // สถานะเริ่มต้น
                createdAt: serverTimestamp()
            });

            // สร้าง QR Code
            document.getElementById('qrcodeDisplay').innerHTML = "";
            new QRCode(document.getElementById("qrcodeDisplay"), {
                text: docRef.id, 
                width: 150, height: 150
            });

            document.getElementById('ticketName').innerText = name;
            document.getElementById('ticketTable').innerText = table;
            document.getElementById('ticketResult').classList.remove('hidden');

            alert("สร้างรายการสำเร็จ!");
            loadBookings();
        } catch (e) {
            console.error("Error: ", e);
            alert("เกิดข้อผิดพลาดในการบันทึก: " + e.message);
        }
    };

    window.resetForm = () => {
        document.getElementById('custName').value = '';
        document.getElementById('custPhone').value = '';
        document.getElementById('tableNo').value = '';
        document.getElementById('paymentRef').value = '';
        document.getElementById('ticketResult').classList.add('hidden');
    }

    // --- 2. ฟังก์ชันสแกน QR ---
    window.startScanner = () => {
        document.getElementById('stopCamBtn').classList.remove('hidden');
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: 250 },
            onScanSuccess,
            onScanFailure
        );
    };

    window.stopScanner = () => {
        if(html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                document.getElementById('reader').innerHTML = "";
                document.getElementById('stopCamBtn').classList.add('hidden');
            });
        }
    }

    const onScanSuccess = async (decodedText, decodedResult) => {
        html5QrcodeScanner.pause();
        const bookingId = decodedText;
        const resultDiv = document.getElementById('scanResult');
        resultDiv.innerHTML = "กำลังตรวจสอบ...";

        try {
            const docRef = doc(db, "bookings", bookingId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.status === "booked") {
                    if(confirm(`ยืนยันลูกค้า?\nชื่อ: ${data.name}\nโต๊ะ: ${data.table}`)) {
                        await updateDoc(docRef, { status: "used", checkInTime: serverTimestamp() });
                        resultDiv.innerHTML = `<div class='alert alert-success'>✅ ผ่าน! เช็คอินเรียบร้อย<br>โต๊ะ: ${data.table}</div>`;
                        loadBookings();
                    }
                } else if (data.status === "used") {
                    resultDiv.innerHTML = `<div class='alert alert-danger'>❌ ไม่ผ่าน! QR นี้ใช้ไปแล้ว</div>`;
                }
            } else {
                resultDiv.innerHTML = `<div class='alert alert-warning'>⚠️ ไม่พบข้อมูลการจอง</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = "เกิดข้อผิดพลาด: " + error.message;
        }
        setTimeout(() => html5QrcodeScanner.resume(), 3000);
    }

    function onScanFailure(error) {}

    // --- 3. ฟังก์ชันโหลดรายการและลบ ---
    window.loadBookings = async () => {
        const listTable = document.getElementById('bookingListTable');
        listTable.innerHTML = "<tr><td colspan='3'>กำลังโหลด...</td></tr>";
        
        const q = query(collection(db, "bookings"), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);
        
        listTable.innerHTML = "";
        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id;
            const statusColor = data.status === 'used' ? 'text-success' : 'text-primary';
            const statusText = data.status === 'used' ? 'ใช้แล้ว' : 'รอใช้งาน';
            
            const row = `
                <tr>
                    <td>
                        <strong>${data.name}</strong><br>
                        <small>โต๊ะ: ${data.table}</small><br>
                        <small class="text-muted">${data.paymentRef || ''}</small>
                    </td>
                    <td class="${statusColor}">${statusText}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteBooking('${id}')">ลบ</button>
                    </td>
                </tr>
            `;
            listTable.innerHTML += row;
        });
    };

    window.deleteBooking = async (id) => {
        if(confirm("ต้องการลบข้อมูลนี้ถาวร?")) {
            await deleteDoc(doc(db, "bookings", id));
            loadBookings();
        }
    };
</script>

</body>
</html>
