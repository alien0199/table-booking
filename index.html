<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÇ‡∏ï‡πä‡∏∞ - ‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤ ‡πÄ‡∏ü‡∏™‡∏ï‡∏¥‡∏ß‡∏±‡∏•</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;700;900&display=swap');

        body { font-family: 'Kanit', sans-serif; background-color: #050505; color: #fff; padding-bottom: 20px; position: relative; min-height: 100vh; }
        .container { max-width: 450px; margin-top: 15px; padding-bottom: 20px; }
        .hidden { display: none !important; }
        
        /* --- ‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πà‡∏≤‡∏ô (Gate Screen) --- */
        #gateScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000000; z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }
        .gate-box {
            background: #1a1a1a; padding: 30px; border-radius: 20px;
            text-align: center; border: 2px solid #333;
            box-shadow: 0 0 30px rgba(0,198,255,0.2);
            width: 100%; max-width: 350px;
        }
        .gate-input {
            background: #333; color: #fff; border: 2px solid #555;
            font-size: 24px; text-align: center; letter-spacing: 5px;
            border-radius: 10px; padding: 10px; width: 100%; margin: 20px 0;
        }

        /* ===== NEW VIP TICKET DESIGN (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤) ===== */
        .vip-ticket {
            display: flex;
            justify-content: center;
            margin: 10px auto;
            width: 100%;
        }

        .vip-border {
            width: 100%;
            max-width: 360px;
            padding: 26px 20px 32px;
            border-radius: 32px;
            background: radial-gradient(circle at top, #7b3cff 0%, #3a145f 40%, #08030f 100%);
            border: 2px solid rgba(255,215,0,0.9);
            box-shadow: 0 0 35px rgba(255,215,0,0.4), 0 0 80px rgba(255,140,0,0.2);
            position: relative;
            text-align: center;
            color: #fff;
            font-family: 'Kanit', sans-serif;
            overflow: hidden;
        }

        /* Header */
        .vip-header .title-main {
            font-size: 28px;
            font-weight: 800;
            text-shadow: 0 0 12px rgba(255,255,255,0.5);
            line-height: 1.1;
        }

        .vip-header .title-sub {
            font-size: 22px;
            font-weight: 800;
            color: #ffeb3b;
            text-shadow: 0 0 12px rgba(255,235,59,0.8);
            margin-bottom: 6px;
        }

        .live-badge {
            display: inline-block;
            margin-top: 6px;
            padding: 4px 16px;
            border-radius: 999px;
            background: rgba(0,0,0,0.45);
            border: 1px solid #ffd700;
            color: #ffd700;
            font-size: 13px;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        /* VIP PASS Label */
        .vip-pass {
            margin: 20px auto 15px;
            padding: 8px 28px;
            border-radius: 18px;
            background: linear-gradient(180deg, #fff1a8, #ffd700);
            color: #000;
            font-weight: 900;
            font-size: 22px;
            letter-spacing: 1px;
            box-shadow: 0 0 25px rgba(255,215,0,0.6), inset 0 -4px 0 rgba(0,0,0,0.25);
            display: inline-block;
            width: 80%;
        }

        /* QR Code */
        .vip-qr {
            background: #fff;
            border-radius: 18px;
            padding: 14px;
            width: 200px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ */
            height: 200px;
            margin: 0 auto 10px;
            box-shadow: 0 0 0 4px #ffd700, 0 0 30px rgba(255,215,0,0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #qrcodeDisplay img, #modalQrcodeDisplay img { display: block; margin: 0 auto; width: 100%; height: auto; }

        .qr-text {
            margin-top: 10px;
            font-size: 10px;
            color: #aaa;
            font-weight: 700;
            letter-spacing: 2px;
        }

        /* Customer Name (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤) */
        .cust-name-display {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* VIP CODE (Table Number) */
        .vip-code {
            margin: 10px auto 18px;
            padding: 5px 20px;
            font-size: 42px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
            font-weight: 900;
            border-radius: 20px;
            background: linear-gradient(180deg, #fff3b0, #ffd700);
            color: #000;
            box-shadow: 0 0 35px rgba(255,215,0,0.6), inset 0 -5px 0 rgba(0,0,0,0.3);
            letter-spacing: 2px;
            display: inline-block;
            min-width: 200px;
        }

        /* Footer */
        .vip-footer {
            font-size: 14px;
            opacity: 0.95;
            color: #ddd;
        }
        .vip-footer span {
            font-size: 12px;
            opacity: 0.7;
            color: #ffeb3b;
        }

        /* --- Other Systems Styles --- */
        .table-badge-mini {
            font-size: 1.5rem; font-weight: 800;
            padding: 5px 15px; border-radius: 8px;
            display: inline-block; width: 100%;
            margin-bottom: 5px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
        }

        .form-control, .form-select { 
            background-color: #ffffff !important; 
            border: 2px solid #ddd;
            color: #0056b3 !important; 
            font-weight: 600; 
            border-radius: 12px; 
            height: 50px; 
            font-size: 1.1rem; 
            text-align: center; 
        }
        .form-control:focus, .form-select:focus { 
            background-color: #f0f8ff !important; 
            border-color: #0056b3; 
            color: #0056b3 !important; 
            box-shadow: 0 0 10px rgba(0, 86, 179, 0.3); 
        }
        .btn-main { background: linear-gradient(90deg, #00c6ff, #0072ff); border: none; height: 55px; font-size: 1.2rem; font-weight: 700; color: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 114, 255, 0.4); }
        .btn-main:disabled { background: #555; color: #aaa; box-shadow: none; cursor: not-allowed; }

        .nav-pills .nav-link { background: #222; color: #aaa; border-radius: 10px; margin: 0 2px; }
        .nav-pills .nav-link.active { background: #6200ea; color: #fff; font-weight: bold; }
        
        .status-card { background: #222; border-radius: 12px; border: 1px solid #333; transition: all 0.2s; cursor: pointer; }
        .status-booked { border-bottom: 4px solid #ffc107; }
        .status-partial { border-bottom: 4px solid #fd7e14; }
        .status-full { border-bottom: 4px solid #2ecc71; opacity: 0.7; }
        
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .admin-table-container { overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .table-custom { background-color: #ffffff; color: #000000; font-size: 0.9rem; width: 100%; white-space: nowrap; margin-bottom: 0; }
        .table-custom th { background-color: #212529; color: #ffeb3b; padding: 15px; font-weight: 600; }
        .table-custom td { vertical-align: middle; color: #000000; padding: 12px 15px; border-bottom: 1px solid #dee2e6; }

        /* --- VIP Mode Styles --- */
        .seat-screen {
            width: 100%; height: 15px; background: #444; margin-bottom: 20px;
            border-radius: 50%; box-shadow: 0 5px 15px rgba(255,255,255,0.1);
            text-align: center; color: #888; font-size: 10px; line-height: 15px;
        }
        .seat-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* ‡πÅ‡∏ñ‡∏ß‡∏•‡∏∞ 5 ‡πÇ‡∏ï‡πä‡∏∞ */
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
            background: #111;
            border-radius: 10px;
        }
        .seat-item {
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 12px 0;
            text-align: center;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            color: #ccc;
            transition: all 0.2s;
            position: relative;
        }
        .seat-item:hover { transform: scale(1.05); border-color: #fff; }

        /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á */
        .seat-taken {
            background-color: #111;
            color: #333;
            border: 1px dashed #333;
            cursor: not-allowed;
            pointer-events: none;
        }
        .seat-taken::after { content: '‚ùå'; position: absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size: 0.8rem; opacity: 0.5; }

        /* ‡∏™‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß */
        .seat-selected { 
            background-color: #ffeb3b !important; 
            color: #000 !important; 
            box-shadow: 0 0 15px rgba(255, 235, 59, 0.5);
            border-color: #ffeb3b;
            transform: scale(1.1);
            font-weight: 800;
        }

        /* ‡∏ò‡∏µ‡∏° VIP */
        .zone-vip-theme { border-bottom: 3px solid #ffeb3b; }

        .selected-display {
            background: #222; border: 1px solid #333; border-radius: 12px;
            padding: 15px; margin-bottom: 20px; text-align: center;
        }
    </style>
</head>
<body>

<div id="gateScreen">
    <div class="gate-box">
        <h2 style="color:#ffeb3b; font-weight:bold; margin-bottom:0;">üîí ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h2>
        <p class="text-secondary small">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
        
        <input type="password" id="accessPass" class="gate-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" inputmode="numeric">
        
        <button onclick="checkAccess()" class="btn btn-primary w-100 py-3 rounded-pill fw-bold fs-5">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
        <p id="gateError" class="text-danger mt-3 small hidden">‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
    </div>
</div>
<div class="container">
    <div class="user-container text-center mb-4">
        <h4 class="fw-bold mb-0">‚ú® ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ <span style="color:#ffeb3b">‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤‡∏Ø</span></h4>
        <h5 class="fw-bold mt-1" style="color: #ffeb3b; text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);">‡πÇ‡∏û-‡∏≠‡∏≠‡∏Å ‡πÄ‡∏ü‡∏™‡∏ï‡∏¥‡∏ß‡∏±‡∏•</h5>

        <ul class="nav nav-pills nav-fill mt-4">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#create">üìù ‡∏à‡∏≠‡∏á</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#status" onclick="loadTableStatus()">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#scan">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin" onclick="checkAdminAccess()">‚öôÔ∏è Admin</button></li>
        </ul>
    </div>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="create">
            <div class="user-container">
                <div class="card p-4 border-0 shadow mb-4" style="background: #151515; border-radius: 20px;">
                    
                    <div class="mb-3 text-center p-2" style="border: 2px solid #ffeb3b; border-radius: 15px; background: rgba(255, 235, 59, 0.1);">
                        <h3 class="fw-bold m-0" style="color: #ffeb3b; text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);">
                            üëë VIP ZONE
                        </h3>
                        <span class="text-white-50 small">‡πÇ‡∏ã‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© 50 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á (VIP001 - VIP050)</span>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between text-white-50 small mb-1">
                            <span>‡∏ú‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á (‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</span>
                            <span id="seatLoading" class="hidden text-warning">‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
                        </div>
                        <div class="seat-screen">STAGE / SCREEN</div>
                        <div id="seatMapContainer" class="seat-grid">
                            </div>
                    </div>

                    <div class="selected-display">
                        <span class="text-secondary small">‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</span>
                        <h2 id="selectedTableText" class="fw-bold m-0" style="color:#777">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</h2>
                        <input type="hidden" id="finalTableNo">
                    </div>

                    <hr class="border-secondary">

                    <div class="mb-3">
                        <input type="text" id="custName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                    </div>
                    <div class="mb-3">
                        <input type="tel" id="custPhone" class="form-control" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
                    </div>
                    <div class="mb-3">
                        <input type="text" id="paymentRef" class="form-control" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                    </div>
                    <div class="mb-3">
                        <select id="paymentMethod" class="form-select">
                            <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                            <option value="‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">üè¶ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                        </select>
                    </div>
                    
                    <button onclick="addBooking()" id="btnSave" class="btn btn-main w-100 mt-2" disabled>‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                </div>
                
                <div id="ticketResult" class="hidden animate__animated animate__fadeInUp">
                    <p class="text-center text-success mb-2">üéâ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>
                    
                    <div class="vip-ticket" id="finalTicket">
                      <div class="vip-border">
                        <div class="vip-header">
                          <div class="title-main">‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤ ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤</div>
                          <div class="title-sub">‡πÇ‡∏û-‡∏≠‡∏≠‡∏Å ‡∏°‡∏¥‡∏ß‡∏™‡∏¥‡∏Ñ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå</div>
                          <div class="live-badge">üéµ LIVE MUSIC CAMP</div>
                        </div>

                        <div class="vip-pass">üëë VIP PASS</div>

                        <div class="vip-qr">
                          <div id="qrcodeDisplay"></div>
                        </div>
                        <div class="qr-text">SCAN FOR ENTRY</div>

                        <div class="mt-3">
                            <div class="cust-name-display" id="displayName">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                        </div>

                        <div class="vip-code" id="displayTable">
                          VIP...
                        </div>

                        <div class="vip-footer">
                          üéµ ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô<br>
                          <span>Music ‚Ä¢ River ‚Ä¢ Camp Night</span>
                        </div>
                      </div>
                    </div>
                    <div class="text-center mt-3 text-muted small">‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üì∏</div>
                    <button onclick="resetForm()" class="btn btn-outline-secondary w-100 mt-3 rounded-pill">‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="status">
            <div class="user-container">
                <button onclick="loadTableStatus()" class="btn btn-sm btn-secondary mb-3 w-100">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                
                <div class="mb-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞..." onkeyup="filterStatus()">
                </div>
                <div class="alert alert-info small text-center p-1 mb-2">‚ÑπÔ∏è ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏á</div>
                <div id="statusList" class="row g-2"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="scan">
            <div class="user-container">
                <div class="card p-3 border-0 bg-dark text-center" style="border-radius: 20px;">
                    <div id="reader" style="border-radius: 15px; overflow: hidden;"></div>
                    <div id="scanResult" class="mt-3 text-white fw-bold">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô...</div>
                    <button onclick="startScanner()" class="btn btn-primary mt-3 w-100 py-3 rounded-pill">üì∏ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                    <button onclick="stopScanner()" class="btn btn-secondary mt-2 w-100 hidden" id="stopCamBtn">‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="admin">
            <div class="user-container" id="adminLoginContainer">
                <div id="adminLoginForm" class="card p-4 bg-dark border-0">
                    <input type="email" id="adminEmail" class="form-control mb-3" placeholder="Email">
                    <input type="password" id="adminPass" class="form-control mb-3" placeholder="Password">
                    <button onclick="login()" class="btn btn-light w-100 py-3 rounded-pill fw-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
            <div id="adminContent" class="hidden">
                <div class="d-flex justify-content-between mb-3 text-white align-items-center">
                    <span class="h4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin)</span>
                    <button onclick="logout()" class="btn btn-sm btn-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
                
                <div class="row g-2 mb-3">
                    <div class="col-8">
                        <button onclick="loadBookingsAdmin()" class="btn btn-info w-100 fw-bold">
                            <i class="bi bi-arrow-clockwise"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                        </button>
                    </div>
                    <div class="col-4">
                        <button onclick="exportToCSV()" class="btn btn-success w-100 fw-bold">
                            üìÇ Export
                        </button>
                    </div>
                </div>

                <div class="admin-table-container">
                    <table class="table table-custom">
                        <thead><tr><th>‡πÇ‡∏ï‡πä‡∏∞</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>üìÖ ‡∏à‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th><th>‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                        <tbody id="adminList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="ticketModal" class="custom-modal-overlay hidden">
    <div style="position: relative; width: 100%; display:flex; justify-content:center;">
        <button onclick="closeTicketModal()" style="position: absolute; top: 0px; right: 10px; z-index: 1000; background: red; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-weight: bold; box-shadow: 0 0 10px rgba(0,0,0,0.5);">X</button>
        
        <div class="vip-ticket">
          <div class="vip-border">
            <div class="vip-header">
              <div class="title-main">‡∏™‡∏£‡∏£‡∏û‡∏¢‡∏≤ ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏≤</div>
              <div class="title-sub">‡πÇ‡∏û-‡∏≠‡∏≠‡∏Å ‡∏°‡∏¥‡∏ß‡∏™‡∏¥‡∏Ñ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå</div>
              <div class="live-badge">üéµ LIVE MUSIC CAMP</div>
            </div>

            <div class="vip-pass">üëë VIP PASS</div>

            <div class="vip-qr">
              <div id="modalQrcodeDisplay"></div>
            </div>
            <div class="qr-text">SCAN FOR ENTRY</div>

            <div class="mt-3">
                <div class="cust-name-display" id="modalDisplayName">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            </div>

            <div class="vip-code" id="modalDisplayTable">
              VIP...
            </div>

            <div class="vip-footer">
              üéµ ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô<br>
              <span>Music ‚Ä¢ River ‚Ä¢ Camp Night</span>
            </div>
          </div>
        </div>
        </div>
    <div class="text-center mt-2 text-white w-100" style="position:absolute; bottom: 20px;">‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ üì∏</div>
</div>

<div id="scanModal" class="custom-modal-overlay hidden">
    <div style="background:#fff;color:#000;width:90%;max-width:400px;padding:25px;border-radius:20px;text-align:center;border:5px solid #ffeb3b;">
        <div style="font-size:2rem;font-weight:800;margin-bottom:10px;">üì• ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</div>
        <div id="modalInfo" style="font-size:1.3rem;font-weight:500;margin-bottom:15px;"></div>
        <label class="d-block text-start fw-bold mt-2" style="font-size:1.2rem;">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Ñ‡∏ô):</label>
        <input type="number" id="modalPaxInput" style="width:100%;height:70px;font-size:3rem;text-align:center;font-weight:bold;border:3px solid #000;border-radius:15px;margin:10px 0 20px 0;background:#f8f9fa;color:#000;" value="1" min="1">
        <button onclick="confirmScan()" class="btn w-100 py-3 fs-4 fw-bold btn-success mb-2">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        <button onclick="closeScanModal()" class="btn w-100 py-3 fs-4 fw-bold btn-danger">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≠‡∏á</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
         <input type="hidden" id="editDocId">
         <div class="mb-3">
             <label class="form-label text-warning">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
             <input type="text" id="editName" class="form-control text-start">
         </div>
         <div class="mb-3">
             <label class="form-label text-warning">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
             <input type="tel" id="editPhone" class="form-control text-start">
         </div>
         <div class="mb-3">
             <label class="form-label text-warning">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
             <input type="text" id="editRef" class="form-control text-start">
         </div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-success" onclick="saveEdit()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="qrModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary">
      <div class="modal-body text-center p-4">
         <div id="qrModalBody" class="bg-white p-3 d-inline-block rounded"></div>
      </div>
      <div class="modal-footer border-secondary p-1">
        <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const ACCESS_PASSWORD = "089050"; // <<-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    const STORAGE_KEY = "sapphaya_event_access";

    function checkAccess() {
        const input = document.getElementById('accessPass').value;
        const err = document.getElementById('gateError');
        
        if(input === ACCESS_PASSWORD) {
            localStorage.setItem(STORAGE_KEY, "granted");
            unlockSystem();
        } else {
            err.classList.remove('hidden');
            document.getElementById('accessPass').value = "";
        }
    }

    function unlockSystem() {
        document.getElementById('gateScreen').classList.add('hidden');
    }

    window.addEventListener('load', () => {
        if(localStorage.getItem(STORAGE_KEY) === "granted") {
            unlockSystem();
        }
    });
</script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyD3s78zRwEHU5WAiSQIg78ZxWbS5QjXYws",
      authDomain: "my-booking-table-855b0.firebaseapp.com",
      projectId: "my-booking-table-855b0",
      storageBucket: "my-booking-table-855b0.firebasestorage.app",
      messagingSenderId: "589914860402",
      appId: "1:589914860402:web:d1033ebdd14b7f982c0beb",
      measurementId: "G-DFMJ4G668D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let html5QrcodeScanner = null;
    let qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
    let editModal = new bootstrap.Modal(document.getElementById('editModal')); 
    let currentScanDoc = null;
    let currentScanData = null;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Cinema Seat (VIP Only) ---
    const MAX_TABLES = 50; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 50 ‡πÇ‡∏ï‡πä‡∏∞
    let selectedTableID = null;

    window.getZoneTheme = (tableNo) => {
        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏≠‡∏á (VIP) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        return { bg: '#ffeb3b', text: '#000' };
    };

    window.renderZone = async () => {
        const zonePrefix = "VIP"; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô VIP ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        const container = document.getElementById('seatMapContainer');
        const loading = document.getElementById('seatLoading');
        
        // Reset ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        selectedTableID = null;
        updateSelectDisplay();
        
        loading.classList.remove('hidden');
        container.innerHTML = ""; 

        try {
            // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏´‡∏ô‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡πâ‡∏≤‡∏á
            const q = query(collection(db, "bookings")); 
            const snapshot = await getDocs(q);
            let takenSeats = [];
            
            snapshot.forEach(doc => {
                const t = doc.data().table; 
                if (t && t.startsWith(zonePrefix)) {
                    takenSeats.push(t);
                }
            });

            // 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ï‡πä‡∏∞ VIP001 - VIP050
            let html = "";
            for(let i = 1; i <= MAX_TABLES; i++) {
                let tableID = zonePrefix + String(i).padStart(3, '0');
                
                let isTaken = takenSeats.includes(tableID);
                let cssClass = isTaken ? 'seat-taken' : 'seat-item';
                let zoneClass = `zone-vip-theme`;
                
                html += `
                    <div id="seat-${tableID}" 
                         class="${cssClass} ${zoneClass}" 
                         onclick="selectSeat('${tableID}')">
                         ${i}
                    </div>`;
            }
            container.innerHTML = html;

        } catch (e) {
            console.error(e);
            container.innerHTML = "<p class='text-danger text-center w-100'>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>";
        } finally {
            loading.classList.add('hidden');
        }
    };

    window.selectSeat = (tableID) => {
        // ‡πÄ‡∏≠‡∏≤‡∏™‡∏µ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°
        if(selectedTableID) {
            const oldSeat = document.getElementById(`seat-${selectedTableID}`);
            if(oldSeat) oldSeat.classList.remove('seat-selected');
        }

        // ‡πÉ‡∏™‡πà‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        selectedTableID = tableID;
        const newSeat = document.getElementById(`seat-${tableID}`);
        if(newSeat) newSeat.classList.add('seat-selected');

        updateSelectDisplay();
    };

    function updateSelectDisplay() {
        const txt = document.getElementById('selectedTableText');
        const btn = document.getElementById('btnSave');
        
        if(selectedTableID) {
            txt.innerText = selectedTableID;
            txt.style.color = window.getZoneTheme(selectedTableID).bg;
            btn.disabled = false;
        } else {
            txt.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            txt.style.color = "#777";
            btn.disabled = true;
        }
    }

    // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô Cinema Seat ---

    function formatThaiDate(timestamp) {
        if(!timestamp) return "-";
        return timestamp.toDate().toLocaleString('th-TH', { 
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
        });
    }

    window.addBooking = async () => {
        const btn = document.getElementById('btnSave');
        const name = document.getElementById('custName').value;
        const phone = document.getElementById('custPhone').value;
        const payMethod = document.getElementById('paymentMethod').value; 
        const payRef = document.getElementById('paymentRef').value; 

        if(!selectedTableID) return alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        if(!name) return alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤");

        btn.disabled = true; btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

        try {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥‡∏ß‡πà‡∏≤‡πÇ‡∏î‡∏ô‡πÅ‡∏¢‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const qCheck = query(collection(db, "bookings"), where("table", "==", selectedTableID));
            const snapCheck = await getDocs(qCheck);
            
            if(!snapCheck.empty) {
                alert(`‚ùå ‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÇ‡∏ï‡πä‡∏∞ ${selectedTableID} ‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ!`);
                // ‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÉ‡∏´‡∏°‡πà
                renderZone(); 
                btn.disabled = false; btn.innerText = "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
                return;
            }

            const docRef = await addDoc(collection(db, "bookings"), {
                name, phone, table: selectedTableID, 
                paymentMethod: payMethod, paymentRef: payRef, 
                status: "booked", pax: 0, maxPax: 4, 
                createdAt: serverTimestamp()
            });

            document.getElementById('ticketResult').classList.remove('hidden');
            const qrContainer = document.getElementById("qrcodeDisplay");
            qrContainer.innerHTML = ""; 
            new QRCode(qrContainer, { text: docRef.id, width: 170, height: 170, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
            
            document.getElementById('displayName').innerText = name;
            
            const badge = document.getElementById('displayTable');
            badge.innerText = selectedTableID;
            // badge.style.background = theme.bg;
            // badge.style.color = theme.text;

            btn.disabled = false; btn.innerText = "‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏Å‡∏î‡∏à‡∏≠‡∏á‡∏ï‡πà‡∏≠)";
            
            // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏±‡∏á
            renderZone();

            setTimeout(() => { document.getElementById('ticketResult').scrollIntoView({behavior: "smooth"}); }, 300);
        } catch (e) { 
            console.error(e); 
            alert("Error: " + e.message); 
            btn.disabled = false; btn.innerText = "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"; 
        }
    };

    window.resetForm = () => {
        document.getElementById('custName').value = '';
        document.getElementById('custPhone').value = '';
        document.getElementById('paymentRef').value = '';
        document.getElementById('ticketResult').classList.add('hidden');
        document.getElementById('qrcodeDisplay').innerHTML = "";
        
        selectedTableID = null;
        updateSelectDisplay();
        
        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ã‡∏ô VIP
        renderZone();
    };

    window.loadTableStatus = async () => {
        const display = document.getElementById('statusList');
        display.innerHTML = "<div class='text-center text-white'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>";
        const q = query(collection(db, "bookings"), orderBy("table", "asc"));
        const snapshot = await getDocs(q);
        display.innerHTML = "";
        
        if(snapshot.empty) { display.innerHTML = "<div class='text-center text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</div>"; return; }

        const totalBooked = snapshot.size;
        display.innerHTML += `
            <div class="col-12 text-center mb-3">
                <span class="badge bg-primary fs-5 shadow px-4 py-2 rounded-pill">
                    üìä ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span class="text-warning fw-bold" style="font-size:1.4em;">${totalBooked}</span> ‡πÇ‡∏ï‡πä‡∏∞
                </span>
            </div>
        `;
        
        snapshot.forEach((doc) => {
            const d = doc.data();
            const currentPax = d.pax || 0;
            const maxPax = d.maxPax || 4;
            let statusClass = 'status-booked';
            let statusText = `üü° ‡∏£‡∏≠ (${currentPax}/${maxPax})`;
            const theme = window.getZoneTheme(d.table); 

            if (currentPax >= maxPax) {
                statusClass = 'status-full';
                statusText = `üü¢ ‡∏Ñ‡∏£‡∏ö (${maxPax}/${maxPax})`;
            } else if (currentPax > 0) {
                statusClass = 'status-partial';
                statusText = `üü† ‡πÄ‡∏Ç‡πâ‡∏≤ ${currentPax}/${maxPax}`;
            }
            
            display.innerHTML += `
                <div class="col-4 col-sm-4 table-card-item" onclick="openTicketModal('${doc.id}', '${d.name}', '${d.table}')">
                    <div class="status-card p-2 text-center ${statusClass}">
                        <div class="table-badge-mini" style="background-color:${theme.bg}; color:${theme.text};">
                            ${d.table}
                        </div>
                        <small class="d-block text-truncate text-secondary" style="font-size:0.8rem;">${d.name}</small>
                        <span class="badge bg-dark mt-1" style="font-size:0.7rem;">${statusText}</span>
                    </div>
                </div>`;
        });
        
        if(document.getElementById('searchInput')) document.getElementById('searchInput').value = '';
    };

    window.filterStatus = () => {
        const input = document.getElementById('searchInput');
        const filter = input.value.toUpperCase();
        const list = document.getElementById('statusList');
        const items = list.getElementsByClassName('table-card-item');

        for (let i = 0; i < items.length; i++) {
            const badge = items[i].getElementsByClassName("table-badge-mini")[0];
            if (badge) {
                const txtValue = badge.textContent || badge.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    items[i].classList.remove('hidden');
                } else {
                    items[i].classList.add('hidden');
                }
            }
        }
    };

    window.openTicketModal = (docId, name, table) => {
        document.getElementById('modalDisplayName').innerText = name;
        const badge = document.getElementById('modalDisplayTable');
        badge.innerText = table;
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á override ‡∏™‡∏µ JS ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ CSS ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß
        // const theme = window.getZoneTheme(table);
        // badge.style.background = theme.bg;
        // badge.style.color = theme.text;

        const qrContainer = document.getElementById("modalQrcodeDisplay");
        qrContainer.innerHTML = ""; 
        new QRCode(qrContainer, { text: docId, width: 170, height: 170, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
        document.getElementById('ticketModal').classList.remove('hidden');
    };

    window.closeTicketModal = () => {
        document.getElementById('ticketModal').classList.add('hidden');
    };

    window.startScanner = () => {
        document.getElementById('stopCamBtn').classList.remove('hidden');
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess, () => {});
    };
    window.stopScanner = () => {
        if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => {
            document.getElementById('reader').innerHTML = "";
            document.getElementById('stopCamBtn').classList.add('hidden');
        });
    };
    
    const onScanSuccess = async (decodedText) => {
        html5QrcodeScanner.pause();
        const resDiv = document.getElementById('scanResult');
        resDiv.innerHTML = "‚è≥ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        
        try {
            const docRef = doc(db, "bookings", decodedText);
            const snap = await getDoc(docRef);
            
            if (snap.exists()) {
                currentScanDoc = docRef;
                currentScanData = snap.data();
                const d = currentScanData;
                const currentPax = d.pax || 0;
                const maxPax = d.maxPax || 4;
                const remaining = maxPax - currentPax;

                if (remaining <= 0) {
                    alert(`‚ùå ‡πÇ‡∏ï‡πä‡∏∞ ${d.table} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö ${maxPax} ‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!`);
                    resDiv.innerHTML = "<h3 class='text-danger'>‚ùå ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß</h3>";
                    setTimeout(() => html5QrcodeScanner.resume(), 2000);
                } else {
                    const theme = window.getZoneTheme(d.table);
                    document.getElementById('modalInfo').innerHTML = `
                        ‡πÇ‡∏ï‡πä‡∏∞: <span style="color:${theme.bg};font-size:1.5rem;font-weight:bold;">${d.table}</span><br>
                        ‡∏ä‡∏∑‡πà‡∏≠: ${d.name}<br>
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ${currentPax}/${maxPax}<br>
                        <span style="color:#d63384">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤: ${remaining} ‡∏Ñ‡∏ô</span>
                    `;
                    document.getElementById('modalPaxInput').value = 1;
                    document.getElementById('modalPaxInput').max = remaining;
                    document.getElementById('scanModal').classList.remove('hidden');
                }
            } else { 
                resDiv.innerHTML = `<h3 class='text-warning fw-bold'>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>`; 
                setTimeout(() => html5QrcodeScanner.resume(), 2000);
            }
        } catch (e) { 
            console.error(e);
            resDiv.innerHTML = "Error: " + e.message;
            setTimeout(() => html5QrcodeScanner.resume(), 2000);
        }
    };

    window.confirmModal = async () => {
        const amount = parseInt(document.getElementById('modalPaxInput').value);
        const currentPax = currentScanData.pax || 0;
        const maxPax = currentScanData.maxPax || 4;
        const remaining = maxPax - currentPax;

        if (amount > 0 && amount <= remaining) {
            const newPax = currentPax + amount;
            await updateDoc(currentScanDoc, { 
                pax: newPax, 
                status: newPax >= maxPax ? 'used' : 'active',
                checkInTime: serverTimestamp() 
            });
            document.getElementById('scanModal').classList.add('hidden');
            document.getElementById('scanResult').innerHTML = `<h3 class='text-success fw-bold'>‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!</h3>‡πÄ‡∏Ç‡πâ‡∏≤ ${amount} ‡∏Ñ‡∏ô (‡∏£‡∏ß‡∏° ${newPax}/${maxPax})`;
            setTimeout(() => html5QrcodeScanner.resume(), 2000); 
        } else {
            alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${remaining} ‡∏Ñ‡∏ô`);
        }
    };
    
    window.closeScanModal = () => {
        document.getElementById('scanModal').classList.add('hidden');
        document.getElementById('scanResult').innerHTML = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô...";
        html5QrcodeScanner.resume();
    };
    
    window.confirmScan = window.confirmModal;
    window.closeScanModal = window.closeScanModal;
    window.openTicketModal = window.openTicketModal;
    window.closeTicketModal = window.closeTicketModal;
    window.filterStatus = window.filterStatus;

    window.login = () => {
        signInWithEmailAndPassword(auth, document.getElementById('adminEmail').value, document.getElementById('adminPass').value)
            .catch((e) => alert("Login Failed: " + e.message));
    };
    window.logout = () => signOut(auth);
    onAuthStateChanged(auth, (user) => {
        document.getElementById('adminLoginContainer').classList.toggle('hidden', !!user);
        document.getElementById('adminContent').classList.toggle('hidden', !user);
    });

    // --- ‡∏™‡πà‡∏ß‡∏ô Admin ---
    window.loadBookingsAdmin = async () => {
        const list = document.getElementById('adminList');
        list.innerHTML = "<tr><td colspan='6' class='text-center text-dark'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>";
        
        try {
            const q = query(collection(db, "bookings"), orderBy("table", "asc"));
            const snapshot = await getDocs(q);
            list.innerHTML = "";
            
            if(snapshot.empty) {
                list.innerHTML = "<tr><td colspan='6' class='text-center text-muted'>- ‡∏ß‡πà‡∏≤‡∏á -</td></tr>";
                return;
            }

            snapshot.forEach((doc) => {
                const d = doc.data();
                const bookedTime = formatThaiDate(d.createdAt);
                
                const theme = window.getZoneTheme(d.table);
                const zoneColor = theme.bg;

                const payBadge = d.paymentMethod === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' ? '<span class="badge bg-success">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>' : '<span class="badge bg-primary">üè¶ ‡πÇ‡∏≠‡∏ô</span>';
                const payInfo = `${payBadge}<br><small class="text-muted fst-italic">${d.paymentRef || '-'}</small>`;

                const currentPax = d.pax || 0;
                const maxPax = d.maxPax || 4;
                let paxBadge = `<span class="badge bg-warning text-dark">‡∏£‡∏≠ (${currentPax}/${maxPax})</span>`;
                if(currentPax >= maxPax) paxBadge = `<span class="badge bg-success">‡∏Ñ‡∏£‡∏ö (${currentPax}/${maxPax})</span>`;
                else if(currentPax > 0) paxBadge = `<span class="badge bg-info text-dark">‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (${currentPax}/${maxPax})</span>`;

                const safeName = (d.name || '').replace(/'/g, "\\'");
                const safeRef = (d.paymentRef || '').replace(/'/g, "\\'");

                list.innerHTML += `
                    <tr>
                        <td class="fw-bold" style="font-size:1.1rem; color:${zoneColor}">${d.table}</td>
                        <td class="text-start text-dark">
                            <div class="fw-bold">${d.name}</div>
                            <small class="text-muted">${d.phone || ''}</small>
                        </td>
                        <td class="text-dark fw-bold">${bookedTime}</td>
                        <td class="text-dark">${payInfo}</td>
                        <td>${paxBadge}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-warning text-dark" onclick="openEdit('${doc.id}', '${safeName}', '${d.phone || ''}', '${safeRef}')">‚úèÔ∏è</button>
                                <button class="btn btn-outline-dark" onclick="showQr('${doc.id}')">QR</button>
                                <button class="btn btn-outline-danger" onclick="del('${doc.id}')">‡∏•‡∏ö</button>
                            </div>
                        </td>
                    </tr>`;
            });
        } catch(e) { console.error(e); }
    };

    window.openEdit = (id, name, phone, ref) => {
        document.getElementById('editDocId').value = id;
        document.getElementById('editName').value = name;
        document.getElementById('editPhone').value = phone;
        document.getElementById('editRef').value = ref;
        editModal.show();
    };

    window.saveEdit = async () => {
        const id = document.getElementById('editDocId').value;
        const name = document.getElementById('editName').value;
        const phone = document.getElementById('editPhone').value;
        const ref = document.getElementById('editRef').value;

        if(!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠");

        try {
            await updateDoc(doc(db, "bookings", id), {
                name: name,
                phone: phone,
                paymentRef: ref
            });
            editModal.hide();
            loadBookingsAdmin(); 
            alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        } catch(e) {
            console.error(e);
            alert("Error: " + e.message);
        }
    };
    
    window.showQr = (id) => {
        document.getElementById('qrModalBody').innerHTML = "";
        new QRCode(document.getElementById("qrModalBody"), { text: id, width: 200, height: 200 });
        qrModal.show();
    };

    window.del = async (id) => { 
        if(confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) { 
            await deleteDoc(doc(db, "bookings", id)); 
            loadBookingsAdmin(); 
        }
    };

    window.exportToCSV = async () => {
        const confirmExport = confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏ó‡∏≥‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
        if (!confirmExport) return;

        try {
            const q = query(collection(db, "bookings"), orderBy("table", "asc"));
            const snapshot = await getDocs(q);

            if (snapshot.empty) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export"); return; }

            let csvContent = "\uFEFF"; 
            csvContent += "Table No.,Customer Name,Phone,Payment Method,Ref/Note,Pax In,Pax Max,Status,Booking Time\n";

            snapshot.forEach(doc => {
                const d = doc.data();
                const cleanName = (d.name || "-").replace(/,/g, " ");
                const cleanRef = (d.paymentRef || "-").replace(/,/g, " ");
                const cleanPhone = (d.phone || "-").replace(/,/g, ""); 
                
                let dateStr = "-";
                if (d.createdAt) {
                    dateStr = d.createdAt.toDate().toLocaleString('th-TH', {
                        year: 'numeric', month: '2-digit', day: '2-digit', 
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });
                }

                const row = [
                    `"${d.table}"`,
                    `"${cleanName}"`,
                    `"${cleanPhone}"`,
                    `"${d.paymentMethod}"`,
                    `"${cleanRef}"`,
                    d.pax || 0,
                    d.maxPax || 4,
                    `"${d.status}"`,
                    `"${dateStr}"`
                ];
                
                csvContent += row.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            const fileName = `booking_report_${new Date().toISOString().slice(0,10)}.csv`;
            
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (e) {
            console.error(e);
            alert("Export Error: " + e.message);
        }
    };
    
    window.del = window.del; 
    window.showQr = window.showQr; 
    window.openEdit = window.openEdit; 
    window.saveEdit = window.saveEdit; 
    window.exportToCSV = window.exportToCSV;

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏±‡∏á‡πÇ‡∏ã‡∏ô VIP (50 ‡πÇ‡∏ï‡πä‡∏∞)
    setTimeout(() => renderZone(), 1000);

</script>

</body>
</html>
